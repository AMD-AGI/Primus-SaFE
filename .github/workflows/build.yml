name: Build
on:
  push:
    branches:
      - '**'
    tags:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      image_version: ${{ steps.get-image-version.outputs.image_version }}
      date_time: ${{ steps.get-current-time.outputs.date_time }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Calculate ImageVersion
      id: get-image-version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
          echo "::set-output name=ImageVersion::$TAG"
        else
          echo "::set-output name=image_version::latest"
        fi
    - name: Get Current Time
      id: get-current-time
      run: |
        FORMATTED_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d%H%M')
        echo "::set-output name=date_time::$FORMATTED_DATE"
        echo "Formatted date: $FORMATTED_DATE"
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files_yaml: |
          apiserver:
            - SaFE/apis/**
            - SaFE/apiserver/**
            - SaFE/charts/primus-safe/templates/apiserver/**
            - SaFE/common/**
            - SaFE/utils/**
          resource_manager:
            - SaFE/apis/**
            - SaFE/resource-manager/**
            - SaFE/charts/primus-safe/templates/resource-manager/**
            - SaFE/common/**
            - SaFE/utils/**
          job_manager:
            - SaFE/apis/**
            - SaFE/job-manager/pkg/**
            - SaFE/job-manager/cmd/** 
            - SaFE/job-manager/installer/run.sh
            - SaFE/job-manager/installer/Dockerfile
            - SaFE/charts/primus-safe/templates/job-manager/**
            - SaFE/common/**
            - SaFE/utils/**
          preprocess:
            - SaFE/job-manager/installer/preprocess/**
          cicd_runner_proxy:
            - SaFE/job-manager/installer/cicd/runner-proxy/**
          cicd_unified_job_proxy:
            - SaFE/job-manager/installer/cicd/unified-job-proxy/**
          webhooks:
            - SaFE/apis/**
            - SaFE/webhooks/**
            - SaFE/charts/primus-safe/templates/webhooks/**
            - SaFE/common/**
            - SaFE/utils/**
          node_agent:
            - SaFE/node-agent/**
            - SaFE/common/**
            - SaFE/utils/**
          sync_image:
            - SaFE/tools/sync-image/**
          telemetry_processor:
            - modules/telemetry-processor/**
            - modules/core/**
          gpu_resource_exporter:
            - modules/exporters/gpu-resource-exporter/**
            - modules/core/**
          system_tuner:
            - modules/system-tuner/**
          primus_safe_adapter:
            - modules/adapter/primus-safe-adapter/**
            - modules/core/**
        files_ignore_yaml: |      
          node_agent:
            - SaFE/node-agent/charts/node-agent/values.yaml
            - SaFE/node-agent/charts/node-agent/Chart.yaml
    - name: Generate matrix
      id: generate-matrix
      run: |
        MATRIX='{"include":['
        if [[ "${{ steps.changed-files.outputs.apiserver_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"apiserver","basepath":"SaFE/apiserver",dockerfile_path:"SaFE/apiserver/installer/Dockerfile"},'
        fi
        if [[ "${{ steps.changed-files.outputs.resource_manager_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"resource-manager","basepath":"SaFE/resource-manager",dockerfile_path:"SaFE/resource-manager/installer/Dockerfile"},'
        fi
        if [[ "${{ steps.changed-files.outputs.job_manager_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"job-manager","basepath":"SaFE/job-manager",dockerfile_path:"SaFE/job-manager/installer/Dockerfile"},'
        fi
        if [[ "${{ steps.changed-files.outputs.preprocess_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"preprocess","basepath":"SaFE/job-manager/installer/preprocess",dockerfile_path:"SaFE/job-manager/installer/preprocess/Dockerfile"},'
        fi
        if [[ "${{ steps.changed-files.outputs.cicd_runner_proxy_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"cicd_runner_proxy","basepath":"SaFE/job-manager/installer/cicd/runner-proxy",dockerfile_path:"SaFE/job-manager/installer/cicd/runner-proxy/Dockerfile"},'
        fi
        if [[ "${{ steps.changed-files.outputs.cicd_unified_job_proxy_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"cicd_unified_job_proxy","basepath":"SaFE/job-manager/installer/cicd/unified-job-proxy",dockerfile_path:"SaFE/job-manager/installer/cicd/unified-job-proxy/Dockerfile"},'
        fi
        if [[ "${{ steps.changed-files.outputs.webhooks_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"webhooks","basepath":"SaFE/webhooks",dockerfile_path:"SaFE/webhooks/installer/Dockerfile"},'
        fi
        if [[ "${{ steps.changed-files.outputs.node_agent_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"node-agent","basepath":"SaFE/node-agent",dockerfile_path:"SaFE/node-agent/installer/Dockerfile"},'
        fi
        if [[ "${{ steps.changed-files.outputs.sync_image_any_changed }}" == "true" ]]; then
          MATRIX+='{"name":"sync-image","basepath":"SaFE/tools/sync-image",dockerfile_path:"SaFE/tools/sync-image/Dockerfile"},'
        fi
        MATRIX=${MATRIX%,} # remove trailing comma
        MATRIX+=']}'
        echo "Generated matrix: $MATRIX"
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  build:
    needs: detect-changes
    runs-on: primus-safe-tw
    outputs:
      primary_tag: ${{ steps.build-and-push.outputs.primary_tag }}
    timeout-minutes: 7200
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    if: ${{ needs.detect-changes.outputs.matrix != '' && needs.detect-changes.outputs.matrix != '{"include":[]}' }}
    steps:
      - uses: actions/checkout@v4
      - name: Login registries
        run: |
          buildah login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}" docker.io
          buildah login --tls-verify=false -u "${{ secrets.HARBOR_USERNAME }}" -p "${{ secrets.HARBOR_PASSWORD }}" "${{ secrets.HARBOR_HOST }}"

      - name: Build and push with Buildah
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          HARBOR_REPOSITORY: ${{ secrets.HARBOR_HOST }}/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          set -e
          echo "ðŸš§ Building ${{ matrix.name }}..."

          buildah bud \
            --layers \
            --build-arg GOPRIXY=https://goproxy.io,direct \
            --build-arg BUILDPATH=${{ matrix.buildpath }} \
            --build-arg BASEPATH=${{ matrix.basepath }} \
            --build-arg APPNAME=${{ matrix.name }} \
            --build-arg GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -t ${{ matrix.name }}:${IMAGE_VERSION} \
            -t ${{ matrix.name }}:${DATE_TIME} \
            -f ${{ matrix.dockerfile_path }} .

          for repo in ${DOCKERIO_REPOSITORY} ${HARBOR_REPOSITORY}; do
            echo "ðŸš€ Pushing ${{ matrix.name }} to $repo..."
            buildah tag ${{ matrix.name }}:${IMAGE_VERSION} ${repo}/${{ matrix.name }}:${IMAGE_VERSION}
            buildah tag ${{ matrix.name }}:${DATE_TIME} ${repo}/${{ matrix.name }}:${DATE_TIME}
            echo "Pushing tags: ${repo}/${{ matrix.name }}:${IMAGE_VERSION}"
            buildah push --tls-verify=false ${repo}/${{ matrix.name }}:${IMAGE_VERSION}
            echo "Pushing tags: ${repo}/${{ matrix.name }}:${DATE_TIME}"
            buildah push --tls-verify=false ${repo}/${{ matrix.name }}:${DATE_TIME}
          done



  

