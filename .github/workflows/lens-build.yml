name: Lens-Build
on:
  push:
    branches:
      - '**'
    tags:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      image_version: ${{ steps.get-image-version.outputs.image_version }}
      date_time: ${{ steps.get-current-time.outputs.date_time }}
      installer_changed: ${{ steps.detect-changes.outputs.installer_changed }}
      tracelens_changed: ${{ steps.detect-changes.outputs.tracelens_changed }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Calculate ImageVersion
      id: get-image-version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
          echo "image_version=$TAG" >> $GITHUB_OUTPUT
        else
          echo "image_version=latest" >> $GITHUB_OUTPUT
        fi
    - name: Get Current Time
      id: get-current-time
      run: |
        FORMATTED_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d%H%M')
        echo "date_time=$FORMATTED_DATE" >> $GITHUB_OUTPUT
    - name: Detect changed files with git diff
      id: detect-changes
      run: |
        set -e
        
        # Determine the base commit for comparison
        if [[ "${{ github.event_name }}" == "push" ]]; then
          if [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
            # New branch, compare HEAD with previous commit
            BASE_COMMIT="HEAD^"
          else
            # Use event.before as the base
            BASE_COMMIT="${{ github.event.before }}"
          fi
          HEAD_COMMIT="${{ github.sha }}"
        else
          # For other event types (e.g. tag), compare the last two commits
          BASE_COMMIT="HEAD^"
          HEAD_COMMIT="HEAD"
        fi
        
        echo "Comparing $BASE_COMMIT...$HEAD_COMMIT"
        
        # Get the list of changed files
        CHANGED_FILES=$(git diff --name-only $BASE_COMMIT $HEAD_COMMIT || echo "")
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Check if each module has changes
        # api: Lens/modules/api/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/api/|^Lens/modules/core/'; then
          echo "api_changed=true" >> $GITHUB_OUTPUT
        else
          echo "api_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # jobs: Lens/modules/jobs/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/jobs/|^Lens/modules/core/'; then
          echo "jobs_changed=true" >> $GITHUB_OUTPUT
        else
          echo "jobs_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # node_exporter: Lens/modules/exporters/node-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/node-exporter/|^Lens/modules/core/'; then
          echo "node_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "node_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # telemetry_processor: Lens/modules/telemetry-processor/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/telemetry-processor/|^Lens/modules/core/'; then
          echo "telemetry_processor_changed=true" >> $GITHUB_OUTPUT
        else
          echo "telemetry_processor_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # gpu_resource_exporter: Lens/modules/exporters/gpu-resource-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/gpu-resource-exporter/|^Lens/modules/core/'; then
          echo "gpu_resource_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "gpu_resource_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # system_tuner: Lens/modules/system-tuner/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/system-tuner/'; then
          echo "system_tuner_changed=true" >> $GITHUB_OUTPUT
        else
          echo "system_tuner_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # network_exporter: Lens/modules/exporters/network-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/network-exporter/|^Lens/modules/core/'; then
          echo "network_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "network_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # primus_safe_adapter: Lens/modules/adapter/primus-safe-adapter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/adapter/primus-safe-adapter/|^Lens/modules/core/'; then
          echo "primus_safe_adapter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "primus_safe_adapter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # multi_cluster_config_exporter: Lens/modules/exporters/multi-cluster-config-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/multi-cluster-config-exporter/|^Lens/modules/core/'; then
          echo "multi_cluster_config_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "multi_cluster_config_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # ai_advisor: Lens/modules/ai-advisor/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/ai-advisor/|^Lens/modules/core/'; then
          echo "ai_advisor_changed=true" >> $GITHUB_OUTPUT
        else
          echo "ai_advisor_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # gateway_exporter: Lens/modules/exporters/gateway-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/gateway-exporter/|^Lens/modules/core/'; then
          echo "gateway_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "gateway_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # inference_metrics_exporter: Lens/modules/exporters/inference-metrics-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/inference-metrics-exporter/|^Lens/modules/core/'; then
          echo "inference_metrics_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "inference_metrics_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # ai_gateway: Lens/modules/ai-gateway/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/ai-gateway/|^Lens/modules/core/'; then
          echo "ai_gateway_changed=true" >> $GITHUB_OUTPUT
        else
          echo "ai_gateway_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # installer: Lens/bootstrap/installer/** or Lens/charts/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/bootstrap/installer/|^Lens/charts/'; then
          echo "installer_changed=true" >> $GITHUB_OUTPUT
        else
          echo "installer_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # tracelens: Lens/docker/tracelens/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/docker/tracelens/'; then
          echo "tracelens_changed=true" >> $GITHUB_OUTPUT
        else
          echo "tracelens_changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate matrix
      id: generate-matrix
      run: |
          MATRIX='{"include":['
          if [[ "${{ steps.detect-changes.outputs.api_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-api","buildpath":"cmd/primus-lens-api","basepath":"Lens/modules/api/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.jobs_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-jobs","buildpath":"cmd/primus-lens-jobs","basepath":"Lens/modules/jobs/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.node_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-node-exporter","buildpath":"cmd/node-exporter","basepath":"Lens/modules/exporters/node-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.telemetry_processor_changed }}" == "true" ]]; then
            MATRIX+='{"name":"telemetry-processor","buildpath":"cmd/telemetry-processor","basepath":"Lens/modules/telemetry-processor/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.gpu_resource_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"gpu-resource-exporter","buildpath":"cmd/gpu-resource-exporter","basepath":"Lens/modules/exporters/gpu-resource-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.system_tuner_changed }}" == "true" ]]; then
            MATRIX+='{"name":"system-tuner","buildpath":"cmd/system-tuner","basepath":"Lens/modules/system-tuner/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.network_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-network-exporter","buildpath":"cmd/network-exporter","basepath":"Lens/modules/exporters/network-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.primus_safe_adapter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-safe-adapter","buildpath":"cmd/primus-safe-adapter","basepath":"Lens/modules/adapter/primus-safe-adapter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.multi_cluster_config_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"multi-cluster-config-exporter","buildpath":"cmd/multi-cluster-config-exporter","basepath":"Lens/modules/exporters/multi-cluster-config-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.ai_advisor_changed }}" == "true" ]]; then
            MATRIX+='{"name":"ai-advisor","buildpath":"cmd/ai-advisor","basepath":"Lens/modules/ai-advisor/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.gateway_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"gateway-exporter","buildpath":"cmd/gateway-exporter","basepath":"Lens/modules/exporters/gateway-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.inference_metrics_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"inference-metrics-exporter","buildpath":"cmd/exporter","basepath":"Lens/modules/exporters/inference-metrics-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.ai_gateway_changed }}" == "true" ]]; then
            MATRIX+='{"name":"ai-gateway","buildpath":"cmd/ai-gateway","basepath":"Lens/modules/ai-gateway/"},'
          fi
          MATRIX=${MATRIX%,} # remove trailing comma
          MATRIX+=']}'
          echo "Generated matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  
  output-version:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Display Image Version
        run: |
          echo "================================================"
          echo "ðŸ“¦ Image Version: ${{ needs.detect-changes.outputs.image_version }}"
          echo "ðŸ“… Build DateTime: ${{ needs.detect-changes.outputs.date_time }}"
          echo "================================================"
  
  build:
    needs: detect-changes
    runs-on: primus-safe-builder
    timeout-minutes: 7200
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    if: ${{ needs.detect-changes.outputs.matrix != '' && needs.detect-changes.outputs.matrix != '{"include":[]}' }}
    env:
      GO_VERSION: "1.24.7"  # Centralized Go version management
    steps:
      - uses: actions/checkout@v4
      - name: Login registries
        run: |
          buildah login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}" docker.io
          buildah login --tls-verify=false -u "${{ secrets.HARBOR_USERNAME }}" -p "${{ secrets.HARBOR_PASSWORD }}" "${{ secrets.HARBOR_HOST }}"

      - name: Build and push with Buildah
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          HARBOR_REPOSITORY: ${{ secrets.HARBOR_HOST }}/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          set -e
          echo "ðŸš§ Building ${{ matrix.name }}..."

          # Determine which Dockerfile to use
          # First check if module has its own Dockerfile in installer directory
          MODULE_DOCKERFILE="${{ matrix.basepath }}installer/Dockerfile"
          FALLBACK_DOCKERFILE="Lens/ci/Dockerfile"
          
          if [[ -f "$MODULE_DOCKERFILE" ]]; then
            DOCKERFILE="$MODULE_DOCKERFILE"
            echo "ðŸ“„ Using module-specific Dockerfile: $DOCKERFILE"
          else
            DOCKERFILE="$FALLBACK_DOCKERFILE"
            echo "ðŸ“„ Using fallback Dockerfile: $DOCKERFILE"
          fi

          buildah bud \
            --layers \
            --build-arg GO_VERSION=${{ env.GO_VERSION }} \
            --build-arg GOPROXY=${{ secrets.GOPROXY }},direct \
            --build-arg BUILDPATH=${{ matrix.buildpath }} \
            --build-arg BASEPATH=${{ matrix.basepath }} \
            --build-arg APPNAME=${{ matrix.name }} \
            --build-arg GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -t ${{ matrix.name }}:${IMAGE_VERSION} \
            -t ${{ matrix.name }}:${DATE_TIME} \
            -f ${DOCKERFILE} .
          

          for repo in ${DOCKERIO_REPOSITORY} ${HARBOR_REPOSITORY}; do
            echo "ðŸš€ Pushing ${{ matrix.name }} to $repo..."
            buildah tag ${{ matrix.name }}:${IMAGE_VERSION} ${repo}/${{ matrix.name }}:${IMAGE_VERSION}
            buildah tag ${{ matrix.name }}:${DATE_TIME} ${repo}/${{ matrix.name }}:${DATE_TIME}
            echo "Pushing tags: ${repo}/${{ matrix.name }}:${IMAGE_VERSION}"
            buildah push --tls-verify=false ${repo}/${{ matrix.name }}:${IMAGE_VERSION}
            echo "Pushing tags: ${repo}/${{ matrix.name }}:${DATE_TIME}"
            buildah push --tls-verify=false ${repo}/${{ matrix.name }}:${DATE_TIME}
          done

      - name: Save build info
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          mkdir -p build-info
          cat > build-info/${{ matrix.name }}.json << EOF
          {
            "name": "${{ matrix.name }}",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "docker_hub": "docker.io/primussafe/${{ matrix.name }}:${IMAGE_VERSION}",
            "docker_hub_datetime": "docker.io/primussafe/${{ matrix.name }}:${DATE_TIME}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.name }}
          path: build-info/${{ matrix.name }}.json
          retention-days: 90

  # Special build job for primus-lens-installer
  # This requires bundling all Helm charts into the image
  build-installer:
    needs: detect-changes
    runs-on: primus-safe-builder
    timeout-minutes: 30
    if: ${{ needs.detect-changes.outputs.installer_changed == 'true' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Login registries
        run: |
          buildah login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}" docker.io
          buildah login --tls-verify=false -u "${{ secrets.HARBOR_USERNAME }}" -p "${{ secrets.HARBOR_PASSWORD }}" "${{ secrets.HARBOR_HOST }}"

      - name: Build and push installer
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          HARBOR_REPOSITORY: ${{ secrets.HARBOR_HOST }}/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          set -e
          echo "ðŸš§ Building primus-lens-installer..."
          
          INSTALLER_DIR="Lens/bootstrap/installer"
          CHARTS_DIR="Lens/charts"
          BUILD_CONTEXT="$INSTALLER_DIR/build-context"
          
          # Create build context with installer source and all charts
          rm -rf "$BUILD_CONTEXT"
          mkdir -p "$BUILD_CONTEXT"
          
          # Copy installer source files
          cp "$INSTALLER_DIR/go.mod" "$INSTALLER_DIR/go.sum" "$BUILD_CONTEXT/"
          cp -r "$INSTALLER_DIR/cmd" "$BUILD_CONTEXT/"
          cp -r "$INSTALLER_DIR/pkg" "$BUILD_CONTEXT/"
          cp -r "$INSTALLER_DIR/internal" "$BUILD_CONTEXT/"
          
          # Copy all Helm charts
          cp -r "$CHARTS_DIR" "$BUILD_CONTEXT/charts"
          
          # Copy Dockerfile
          cp "$INSTALLER_DIR/Dockerfile" "$BUILD_CONTEXT/"
          
          echo "ðŸ“„ Build context created at $BUILD_CONTEXT"
          ls -la "$BUILD_CONTEXT"
          
          # Build the image
          buildah bud \
            --layers \
            -t primus-lens-installer:${IMAGE_VERSION} \
            -t primus-lens-installer:${DATE_TIME} \
            -f "$BUILD_CONTEXT/Dockerfile" \
            "$BUILD_CONTEXT"
          
          # Push to registries
          for repo in ${DOCKERIO_REPOSITORY} ${HARBOR_REPOSITORY}; do
            echo "ðŸš€ Pushing primus-lens-installer to $repo..."
            buildah tag primus-lens-installer:${IMAGE_VERSION} ${repo}/primus-lens-installer:${IMAGE_VERSION}
            buildah tag primus-lens-installer:${DATE_TIME} ${repo}/primus-lens-installer:${DATE_TIME}
            buildah push --tls-verify=false ${repo}/primus-lens-installer:${IMAGE_VERSION}
            buildah push --tls-verify=false ${repo}/primus-lens-installer:${DATE_TIME}
          done
          
          # Cleanup
          rm -rf "$BUILD_CONTEXT"
          
          echo "âœ… primus-lens-installer build and push completed!"

      - name: Save build info
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          mkdir -p build-info
          cat > build-info/primus-lens-installer.json << EOF
          {
            "name": "primus-lens-installer",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "docker_hub": "docker.io/primussafe/primus-lens-installer:${IMAGE_VERSION}",
            "docker_hub_datetime": "docker.io/primussafe/primus-lens-installer:${DATE_TIME}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info-primus-lens-installer
          path: build-info/primus-lens-installer.json
          retention-days: 90

  # TraceLens image build job
  # Python-based Streamlit application for trace analysis
  build-tracelens:
    needs: detect-changes
    runs-on: primus-safe-builder
    timeout-minutes: 30
    if: ${{ needs.detect-changes.outputs.tracelens_changed == 'true' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Login registries
        run: |
          buildah login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}" docker.io
          buildah login --tls-verify=false -u "${{ secrets.HARBOR_USERNAME }}" -p "${{ secrets.HARBOR_PASSWORD }}" "${{ secrets.HARBOR_HOST }}"

      - name: Build and push TraceLens
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          HARBOR_REPOSITORY: ${{ secrets.HARBOR_HOST }}/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          set -e
          echo "ðŸš§ Building tracelens..."
          
          TRACELENS_DIR="Lens/docker/tracelens"
          
          # Build the image
          buildah bud \
            --layers \
            -t tracelens:${IMAGE_VERSION} \
            -t tracelens:${DATE_TIME} \
            -f "${TRACELENS_DIR}/Dockerfile" \
            "${TRACELENS_DIR}"
          
          # Push to registries
          for repo in ${DOCKERIO_REPOSITORY} ${HARBOR_REPOSITORY}; do
            echo "ðŸš€ Pushing tracelens to $repo..."
            buildah tag tracelens:${IMAGE_VERSION} ${repo}/tracelens:${IMAGE_VERSION}
            buildah tag tracelens:${DATE_TIME} ${repo}/tracelens:${DATE_TIME}
            buildah push --tls-verify=false ${repo}/tracelens:${IMAGE_VERSION}
            buildah push --tls-verify=false ${repo}/tracelens:${DATE_TIME}
          done
          
          echo "âœ… tracelens build and push completed!"

      - name: Save build info
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          mkdir -p build-info
          cat > build-info/tracelens.json << EOF
          {
            "name": "tracelens",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "docker_hub": "docker.io/primussafe/tracelens:${IMAGE_VERSION}",
            "docker_hub_datetime": "docker.io/primussafe/tracelens:${DATE_TIME}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info-tracelens
          path: build-info/tracelens.json
          retention-days: 90

  # Summarize all build results into a single manifest artifact
  summarize-build:
    needs: [detect-changes, build, build-installer, build-tracelens]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all build info artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-info-*
          path: all-build-info
          merge-multiple: false

      - name: Generate build manifest
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          echo "ðŸ“‹ Generating build manifest..."
          
          # Create manifest header
          cat > build-manifest.json << EOF
          {
            "workflow": "Lens-Build",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "components": [
          EOF
          
          # Merge all component build info
          FIRST=true
          if ls all-build-info/*/build-info/*.json 1> /dev/null 2>&1; then
            for f in all-build-info/*/build-info/*.json; do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "," >> build-manifest.json
              fi
              cat "$f" >> build-manifest.json
            done
          elif ls all-build-info/*/*.json 1> /dev/null 2>&1; then
            for f in all-build-info/*/*.json; do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "," >> build-manifest.json
              fi
              cat "$f" >> build-manifest.json
            done
          fi
          
          # Close the JSON
          echo "" >> build-manifest.json
          echo "  ]" >> build-manifest.json
          echo "}" >> build-manifest.json
          
          echo "ðŸ“„ Build manifest content:"
          cat build-manifest.json
          
          # Also create a simple text version for quick reference
          cat > build-versions.txt << EOF
          ================================================
          Lens Build Summary
          ================================================
          Workflow Run: ${{ github.run_id }}
          Image Version: ${IMAGE_VERSION}
          DateTime Tag: ${DATE_TIME}
          Commit: ${{ github.sha }}
          Ref: ${{ github.ref }}
          Build Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ================================================
          
          Built Components:
          EOF
          
          if ls all-build-info/*/build-info/*.json 1> /dev/null 2>&1; then
            for f in all-build-info/*/build-info/*.json; do
              NAME=$(cat "$f" | grep -o '"name": "[^"]*"' | cut -d'"' -f4)
              echo "  - $NAME:${IMAGE_VERSION}" >> build-versions.txt
              echo "  - $NAME:${DATE_TIME}" >> build-versions.txt
            done
          elif ls all-build-info/*/*.json 1> /dev/null 2>&1; then
            for f in all-build-info/*/*.json; do
              NAME=$(cat "$f" | grep -o '"name": "[^"]*"' | cut -d'"' -f4)
              echo "  - $NAME:${IMAGE_VERSION}" >> build-versions.txt
              echo "  - $NAME:${DATE_TIME}" >> build-versions.txt
            done
          fi
          
          echo "" >> build-versions.txt
          echo "Docker Hub Registry: docker.io/primussafe/" >> build-versions.txt
          echo "================================================" >> build-versions.txt
          
          echo ""
          echo "ðŸ“„ Build versions summary:"
          cat build-versions.txt

      - name: Upload build manifest
        uses: actions/upload-artifact@v4
        with:
          name: lens-build-manifest
          path: |
            build-manifest.json
            build-versions.txt
          retention-days: 90

