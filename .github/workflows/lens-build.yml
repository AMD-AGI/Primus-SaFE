name: Lens-Build
on:
  push:
    branches:
      - '**'
    tags:
      - '**'

permissions:
  contents: read
  packages: write  # Required for ghcr.io push

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      image_version: ${{ steps.get-image-version.outputs.image_version }}
      date_time: ${{ steps.get-current-time.outputs.date_time }}
      tracelens_changed: ${{ steps.detect-changes.outputs.tracelens_changed }}
      perfetto_changed: ${{ steps.detect-changes.outputs.perfetto_changed }}
      github_runner_changed: ${{ steps.detect-changes.outputs.github_runner_changed }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Calculate ImageVersion
      id: get-image-version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
          echo "image_version=$TAG" >> $GITHUB_OUTPUT
        else
          echo "image_version=latest" >> $GITHUB_OUTPUT
        fi
    - name: Get Current Time
      id: get-current-time
      run: |
        FORMATTED_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d%H%M')
        echo "date_time=$FORMATTED_DATE" >> $GITHUB_OUTPUT
    - name: Detect changed files with git diff
      id: detect-changes
      run: |
        set -e
        
        # Determine the base commit for comparison
        if [[ "${{ github.event_name }}" == "push" ]]; then
          if [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
            # New branch, compare HEAD with previous commit
            BASE_COMMIT="HEAD^"
          else
            # Use event.before as the base
            BASE_COMMIT="${{ github.event.before }}"
          fi
          HEAD_COMMIT="${{ github.sha }}"
        else
          # For other event types (e.g. tag), compare the last two commits
          BASE_COMMIT="HEAD^"
          HEAD_COMMIT="HEAD"
        fi
        
        echo "Comparing $BASE_COMMIT...$HEAD_COMMIT"
        
        # Get the list of changed files
        CHANGED_FILES=$(git diff --name-only $BASE_COMMIT $HEAD_COMMIT || echo "")
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Check if each module has changes
        # api: Lens/modules/api/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/api/|^Lens/modules/core/'; then
          echo "api_changed=true" >> $GITHUB_OUTPUT
        else
          echo "api_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # jobs: Lens/modules/jobs/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/jobs/|^Lens/modules/core/'; then
          echo "jobs_changed=true" >> $GITHUB_OUTPUT
        else
          echo "jobs_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # node_exporter: Lens/modules/exporters/node-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/node-exporter/|^Lens/modules/core/'; then
          echo "node_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "node_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # telemetry_processor: Lens/modules/telemetry-processor/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/telemetry-processor/|^Lens/modules/core/'; then
          echo "telemetry_processor_changed=true" >> $GITHUB_OUTPUT
        else
          echo "telemetry_processor_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # gpu_resource_exporter: Lens/modules/exporters/gpu-resource-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/gpu-resource-exporter/|^Lens/modules/core/'; then
          echo "gpu_resource_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "gpu_resource_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # system_tuner: Lens/modules/system-tuner/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/system-tuner/'; then
          echo "system_tuner_changed=true" >> $GITHUB_OUTPUT
        else
          echo "system_tuner_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # network_exporter: Lens/modules/exporters/network-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/network-exporter/|^Lens/modules/core/'; then
          echo "network_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "network_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # primus_safe_adapter: Lens/modules/adapter/primus-safe-adapter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/adapter/primus-safe-adapter/|^Lens/modules/core/'; then
          echo "primus_safe_adapter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "primus_safe_adapter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # multi_cluster_config_exporter: Lens/modules/exporters/multi-cluster-config-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/multi-cluster-config-exporter/|^Lens/modules/core/'; then
          echo "multi_cluster_config_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "multi_cluster_config_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # ai_advisor: Lens/modules/ai-advisor/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/ai-advisor/|^Lens/modules/core/'; then
          echo "ai_advisor_changed=true" >> $GITHUB_OUTPUT
        else
          echo "ai_advisor_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # gateway_exporter: Lens/modules/exporters/gateway-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/gateway-exporter/|^Lens/modules/core/'; then
          echo "gateway_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "gateway_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # inference_metrics_exporter: Lens/modules/exporters/inference-metrics-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/inference-metrics-exporter/|^Lens/modules/core/'; then
          echo "inference_metrics_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "inference_metrics_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # ai_gateway: Lens/modules/ai-gateway/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/ai-gateway/|^Lens/modules/core/'; then
          echo "ai_gateway_changed=true" >> $GITHUB_OUTPUT
        else
          echo "ai_gateway_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # github_runners_exporter: Lens/modules/exporters/github-runners-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/github-runners-exporter/|^Lens/modules/core/'; then
          echo "github_runners_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "github_runners_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # storage_exporter: Lens/modules/exporters/storage-exporter/** or Lens/modules/core/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/exporters/storage-exporter/|^Lens/modules/core/'; then
          echo "storage_exporter_changed=true" >> $GITHUB_OUTPUT
        else
          echo "storage_exporter_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # installer: Lens/modules/installer/** or Lens/modules/core/** or Lens/charts/**
        # Charts are bundled into installer image, so chart changes should trigger rebuild
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/installer/|^Lens/modules/core/|^Lens/charts/'; then
          echo "installer_changed=true" >> $GITHUB_OUTPUT
        else
          echo "installer_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # control_plane_controller: Lens/modules/control-plane-controller/** or Lens/modules/core/** or Lens/modules/jobs/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/modules/control-plane-controller/|^Lens/modules/core/|^Lens/modules/jobs/'; then
          echo "control_plane_controller_changed=true" >> $GITHUB_OUTPUT
        else
          echo "control_plane_controller_changed=false" >> $GITHUB_OUTPUT
        fi
        
        
        # tracelens: Lens/docker/tracelens/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/docker/tracelens/'; then
          echo "tracelens_changed=true" >> $GITHUB_OUTPUT
        else
          echo "tracelens_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # perfetto: Lens/docker/perfetto/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/docker/perfetto/'; then
          echo "perfetto_changed=true" >> $GITHUB_OUTPUT
        else
          echo "perfetto_changed=false" >> $GITHUB_OUTPUT
        fi
        
        # github_runner: Lens/docker/github-runner/**
        if echo "$CHANGED_FILES" | grep -qE '^Lens/docker/github-runner/'; then
          echo "github_runner_changed=true" >> $GITHUB_OUTPUT
        else
          echo "github_runner_changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate matrix
      id: generate-matrix
      run: |
          MATRIX='{"include":['
          if [[ "${{ steps.detect-changes.outputs.api_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-api","buildpath":"cmd/primus-lens-api","basepath":"Lens/modules/api/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.jobs_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-jobs","buildpath":"cmd/primus-lens-jobs","basepath":"Lens/modules/jobs/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.node_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-node-exporter","buildpath":"cmd/node-exporter","basepath":"Lens/modules/exporters/node-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.telemetry_processor_changed }}" == "true" ]]; then
            MATRIX+='{"name":"telemetry-processor","buildpath":"cmd/telemetry-processor","basepath":"Lens/modules/telemetry-processor/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.gpu_resource_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"gpu-resource-exporter","buildpath":"cmd/gpu-resource-exporter","basepath":"Lens/modules/exporters/gpu-resource-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.system_tuner_changed }}" == "true" ]]; then
            MATRIX+='{"name":"system-tuner","buildpath":"cmd/system-tuner","basepath":"Lens/modules/system-tuner/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.network_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-network-exporter","buildpath":"cmd/network-exporter","basepath":"Lens/modules/exporters/network-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.primus_safe_adapter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-safe-adapter","buildpath":"cmd/primus-safe-adapter","basepath":"Lens/modules/adapter/primus-safe-adapter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.multi_cluster_config_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"multi-cluster-config-exporter","buildpath":"cmd/multi-cluster-config-exporter","basepath":"Lens/modules/exporters/multi-cluster-config-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.ai_advisor_changed }}" == "true" ]]; then
            MATRIX+='{"name":"ai-advisor","buildpath":"cmd/ai-advisor","basepath":"Lens/modules/ai-advisor/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.gateway_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"gateway-exporter","buildpath":"cmd/gateway-exporter","basepath":"Lens/modules/exporters/gateway-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.inference_metrics_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"inference-metrics-exporter","buildpath":"cmd/exporter","basepath":"Lens/modules/exporters/inference-metrics-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.ai_gateway_changed }}" == "true" ]]; then
            MATRIX+='{"name":"ai-gateway","buildpath":"cmd/ai-gateway","basepath":"Lens/modules/ai-gateway/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.github_runners_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"github-runners-exporter","buildpath":"cmd/github-runners-exporter","basepath":"Lens/modules/exporters/github-runners-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.storage_exporter_changed }}" == "true" ]]; then
            MATRIX+='{"name":"storage-exporter","buildpath":"cmd/storage-exporter","basepath":"Lens/modules/exporters/storage-exporter/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.installer_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-installer","buildpath":"cmd","basepath":"Lens/modules/installer/"},'
          fi
          if [[ "${{ steps.detect-changes.outputs.control_plane_controller_changed }}" == "true" ]]; then
            MATRIX+='{"name":"control-plane-controller","buildpath":"cmd/control-plane-controller","basepath":"Lens/modules/control-plane-controller/"},'
          fi
          MATRIX=${MATRIX%,} # remove trailing comma
          MATRIX+=']}'
          echo "Generated matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  
  output-version:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Display Image Version
        run: |
          echo "================================================"
          echo "ðŸ“¦ Image Version: ${{ needs.detect-changes.outputs.image_version }}"
          echo "ðŸ“… Build DateTime: ${{ needs.detect-changes.outputs.date_time }}"
          echo "================================================"
  
  build:
    needs: detect-changes
    runs-on: primus-safe-tw-proj2
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    if: ${{ needs.detect-changes.outputs.matrix != '' && needs.detect-changes.outputs.matrix != '{"include":[]}' }}
    env:
      GO_VERSION: "1.24.7"  # Centralized Go version management
      REGISTRY: "${{ secrets.PROJ2_HARBOR_HOST }}/primussafe/"
    steps:
      - uses: actions/checkout@v4

      - name: Login registries
        run: |
          set -x
          echo "ðŸ” Logging in to Docker Hub..."
          buildah login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}" docker.io && echo "âœ… Docker Hub login successful" || echo "âŒ Docker Hub login failed"
          
          echo "ðŸ” Logging in to GitHub Container Registry..."
          buildah login -u "${{ github.actor }}" -p "${{ secrets.GITHUB_TOKEN }}" ghcr.io && echo "âœ… GHCR login successful" || echo "âŒ GHCR login failed"

      - name: Build and push with Buildah
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          GHCR_REPOSITORY: ghcr.io/amd-agi/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          set -e
          echo "ðŸš§ Building ${{ matrix.name }}..."

          # Determine which Dockerfile to use
          # Check in order: basepath/Dockerfile, basepath/installer/Dockerfile, fallback
          MODULE_DOCKERFILE="${{ matrix.basepath }}Dockerfile"
          INSTALLER_DOCKERFILE="${{ matrix.basepath }}installer/Dockerfile"
          FALLBACK_DOCKERFILE="Lens/ci/Dockerfile"
          
          if [[ -f "$MODULE_DOCKERFILE" ]]; then
            DOCKERFILE="$MODULE_DOCKERFILE"
            echo "ðŸ“„ Using module Dockerfile: $DOCKERFILE"
          elif [[ -f "$INSTALLER_DOCKERFILE" ]]; then
            DOCKERFILE="$INSTALLER_DOCKERFILE"
            echo "ðŸ“„ Using module-specific installer Dockerfile: $DOCKERFILE"
          else
            DOCKERFILE="$FALLBACK_DOCKERFILE"
            echo "ðŸ“„ Using fallback Dockerfile: $DOCKERFILE"
          fi

          # Build with buildah
          buildah bud \
            --layers \
            --tls-verify=false \
            --build-arg REGISTRY=${{ env.REGISTRY }} \
            --build-arg GO_VERSION=${{ env.GO_VERSION }} \
            --build-arg GOPROXY=https://proxy.golang.org,direct \
            --build-arg BUILDPATH=${{ matrix.buildpath }} \
            --build-arg BASEPATH=${{ matrix.basepath }} \
            --build-arg APPNAME=${{ matrix.name }} \
            --build-arg GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -t ${{ matrix.name }}:${IMAGE_VERSION} \
            -t ${{ matrix.name }}:${DATE_TIME} \
            -f ${DOCKERFILE} .

          # Push to Docker Hub
          echo "ðŸš€ Pushing ${{ matrix.name }} to Docker Hub..."
          buildah tag ${{ matrix.name }}:${IMAGE_VERSION} ${DOCKERIO_REPOSITORY}/${{ matrix.name }}:${IMAGE_VERSION}
          buildah tag ${{ matrix.name }}:${DATE_TIME} ${DOCKERIO_REPOSITORY}/${{ matrix.name }}:${DATE_TIME}
          buildah push --tls-verify=false ${DOCKERIO_REPOSITORY}/${{ matrix.name }}:${IMAGE_VERSION}
          buildah push --tls-verify=false ${DOCKERIO_REPOSITORY}/${{ matrix.name }}:${DATE_TIME}

          # Push to GHCR
          echo "ðŸš€ Pushing ${{ matrix.name }} to GHCR..."
          buildah tag ${{ matrix.name }}:${IMAGE_VERSION} ${GHCR_REPOSITORY}/${{ matrix.name }}:${IMAGE_VERSION}
          buildah tag ${{ matrix.name }}:${DATE_TIME} ${GHCR_REPOSITORY}/${{ matrix.name }}:${DATE_TIME}
          buildah push --tls-verify=false ${GHCR_REPOSITORY}/${{ matrix.name }}:${IMAGE_VERSION}
          buildah push --tls-verify=false ${GHCR_REPOSITORY}/${{ matrix.name }}:${DATE_TIME}
          
          echo "âœ… ${{ matrix.name }} build and push completed!"

      - name: Save build info
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          mkdir -p build-info
          cat > build-info/${{ matrix.name }}.json << EOF
          {
            "name": "${{ matrix.name }}",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "docker_hub": "docker.io/primussafe/${{ matrix.name }}:${IMAGE_VERSION}",
            "docker_hub_datetime": "docker.io/primussafe/${{ matrix.name }}:${DATE_TIME}",
            "ghcr": "ghcr.io/amd-agi/primussafe/${{ matrix.name }}:${IMAGE_VERSION}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.name }}
          path: build-info/${{ matrix.name }}.json
          retention-days: 90

  # TraceLens image build job
  # Python-based Streamlit application for trace analysis
  build-tracelens:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ needs.detect-changes.outputs.tracelens_changed == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push TraceLens
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          GHCR_REPOSITORY: ghcr.io/amd-agi/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          set -e
          echo "ðŸš§ Building tracelens..."
          
          TRACELENS_DIR="Lens/docker/tracelens"
          
          # Build and push the image
          docker buildx build \
            --platform linux/amd64 \
            -t ${DOCKERIO_REPOSITORY}/tracelens:${IMAGE_VERSION} \
            -t ${DOCKERIO_REPOSITORY}/tracelens:${DATE_TIME} \
            -t ${GHCR_REPOSITORY}/tracelens:${IMAGE_VERSION} \
            -t ${GHCR_REPOSITORY}/tracelens:${DATE_TIME} \
            -f "${TRACELENS_DIR}/Dockerfile" \
            --push \
            "${TRACELENS_DIR}"
          
          echo "âœ… tracelens build and push completed!"

      - name: Save build info
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          mkdir -p build-info
          cat > build-info/tracelens.json << EOF
          {
            "name": "tracelens",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "docker_hub": "docker.io/primussafe/tracelens:${IMAGE_VERSION}",
            "docker_hub_datetime": "docker.io/primussafe/tracelens:${DATE_TIME}",
            "ghcr": "ghcr.io/amd-agi/primussafe/tracelens:${IMAGE_VERSION}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info-tracelens
          path: build-info/tracelens.json
          retention-days: 90

  # Perfetto Viewer image build job
  # Nginx-based container for Perfetto trace visualization
  build-perfetto:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ needs.detect-changes.outputs.perfetto_changed == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Perfetto Viewer
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          GHCR_REPOSITORY: ghcr.io/amd-agi/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          set -e
          echo "ðŸš§ Building perfetto-viewer..."
          
          PERFETTO_DIR="Lens/docker/perfetto"
          
          # Build and push the image
          docker buildx build \
            --platform linux/amd64 \
            -t ${DOCKERIO_REPOSITORY}/perfetto-viewer:${IMAGE_VERSION} \
            -t ${DOCKERIO_REPOSITORY}/perfetto-viewer:${DATE_TIME} \
            -t ${GHCR_REPOSITORY}/perfetto-viewer:${IMAGE_VERSION} \
            -t ${GHCR_REPOSITORY}/perfetto-viewer:${DATE_TIME} \
            -f "${PERFETTO_DIR}/Dockerfile" \
            --push \
            "${PERFETTO_DIR}"
          
          echo "âœ… perfetto-viewer build and push completed!"

      - name: Save build info
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          mkdir -p build-info
          cat > build-info/perfetto-viewer.json << EOF
          {
            "name": "perfetto-viewer",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "docker_hub": "docker.io/primussafe/perfetto-viewer:${IMAGE_VERSION}",
            "docker_hub_datetime": "docker.io/primussafe/perfetto-viewer:${DATE_TIME}",
            "ghcr": "ghcr.io/amd-agi/primussafe/perfetto-viewer:${IMAGE_VERSION}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info-perfetto-viewer
          path: build-info/perfetto-viewer.json
          retention-days: 90

  # GitHub Runner image build job
  # Based on ubuntu with GitHub Actions Runner
  build-github-runner:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ needs.detect-changes.outputs.github_runner_changed == 'true' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Read runner version from env file
        id: read-version
        run: |
          source Lens/docker/github-runner/version.env
          echo "runner_version=${RUNNER_VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ GitHub Actions Runner Version: ${RUNNER_VERSION}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push GitHub Runner
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          GHCR_REPOSITORY: ghcr.io/amd-agi/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
          RUNNER_VERSION: ${{ steps.read-version.outputs.runner_version }}
        run: |
          set -e
          echo "ðŸš§ Building github-runner with GitHub Actions Runner v${RUNNER_VERSION}..."
          
          GITHUB_RUNNER_DIR="Lens/docker/github-runner"
          
          # Build and push the image
          docker buildx build \
            --platform linux/amd64 \
            --build-arg RUNNER_VERSION=${RUNNER_VERSION} \
            -t ${DOCKERIO_REPOSITORY}/github-runner:${IMAGE_VERSION} \
            -t ${DOCKERIO_REPOSITORY}/github-runner:${DATE_TIME} \
            -t ${DOCKERIO_REPOSITORY}/github-runner:v${RUNNER_VERSION} \
            -t ${GHCR_REPOSITORY}/github-runner:${IMAGE_VERSION} \
            -t ${GHCR_REPOSITORY}/github-runner:${DATE_TIME} \
            -t ${GHCR_REPOSITORY}/github-runner:v${RUNNER_VERSION} \
            -f "${GITHUB_RUNNER_DIR}/Dockerfile" \
            --push \
            "${GITHUB_RUNNER_DIR}"
          
          echo "âœ… github-runner build and push completed!"

      - name: Save build info
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
          RUNNER_VERSION: ${{ steps.read-version.outputs.runner_version }}
        run: |
          mkdir -p build-info
          cat > build-info/github-runner.json << EOF
          {
            "name": "github-runner",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "runner_version": "v${RUNNER_VERSION}",
            "docker_hub": "docker.io/primussafe/github-runner:${IMAGE_VERSION}",
            "docker_hub_datetime": "docker.io/primussafe/github-runner:${DATE_TIME}",
            "docker_hub_runner_version": "docker.io/primussafe/github-runner:v${RUNNER_VERSION}",
            "ghcr": "ghcr.io/amd-agi/primussafe/github-runner:${IMAGE_VERSION}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}"
          }
          EOF

      - name: Upload build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info-github-runner
          path: build-info/github-runner.json
          retention-days: 90

  # Summarize all build results into a single manifest artifact
  summarize-build:
    needs: [detect-changes, build, build-tracelens, build-perfetto, build-github-runner]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all build info artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-info-*
          path: all-build-info
          merge-multiple: false

      - name: Generate build manifest
        env:
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          echo "ðŸ“‹ Generating build manifest..."
          
          # Create manifest header
          cat > build-manifest.json << EOF
          {
            "workflow": "Lens-Build",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "image_version": "${IMAGE_VERSION}",
            "date_time": "${DATE_TIME}",
            "commit_sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "build_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "components": [
          EOF
          
          # Merge all component build info
          FIRST=true
          if ls all-build-info/*/build-info/*.json 1> /dev/null 2>&1; then
            for f in all-build-info/*/build-info/*.json; do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "," >> build-manifest.json
              fi
              cat "$f" >> build-manifest.json
            done
          elif ls all-build-info/*/*.json 1> /dev/null 2>&1; then
            for f in all-build-info/*/*.json; do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "," >> build-manifest.json
              fi
              cat "$f" >> build-manifest.json
            done
          fi
          
          # Close the JSON
          echo "" >> build-manifest.json
          echo "  ]" >> build-manifest.json
          echo "}" >> build-manifest.json
          
          echo "ðŸ“„ Build manifest content:"
          cat build-manifest.json
          
          # Also create a simple text version for quick reference
          cat > build-versions.txt << EOF
          ================================================
          Lens Build Summary
          ================================================
          Workflow Run: ${{ github.run_id }}
          Image Version: ${IMAGE_VERSION}
          DateTime Tag: ${DATE_TIME}
          Commit: ${{ github.sha }}
          Ref: ${{ github.ref }}
          Build Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ================================================
          
          Built Components:
          EOF
          
          if ls all-build-info/*/build-info/*.json 1> /dev/null 2>&1; then
            for f in all-build-info/*/build-info/*.json; do
              NAME=$(cat "$f" | grep -o '"name": "[^"]*"' | cut -d'"' -f4)
              echo "  - $NAME:${IMAGE_VERSION}" >> build-versions.txt
              echo "  - $NAME:${DATE_TIME}" >> build-versions.txt
            done
          elif ls all-build-info/*/*.json 1> /dev/null 2>&1; then
            for f in all-build-info/*/*.json; do
              NAME=$(cat "$f" | grep -o '"name": "[^"]*"' | cut -d'"' -f4)
              echo "  - $NAME:${IMAGE_VERSION}" >> build-versions.txt
              echo "  - $NAME:${DATE_TIME}" >> build-versions.txt
            done
          fi
          
          echo "" >> build-versions.txt
          echo "Docker Hub Registry: docker.io/primussafe/" >> build-versions.txt
          echo "GHCR Registry: ghcr.io/amd-agi/primussafe/" >> build-versions.txt
          echo "================================================" >> build-versions.txt
          
          echo ""
          echo "ðŸ“„ Build versions summary:"
          cat build-versions.txt

      - name: Upload build manifest
        uses: actions/upload-artifact@v4
        with:
          name: lens-build-manifest
          path: |
            build-manifest.json
            build-versions.txt
          retention-days: 90
