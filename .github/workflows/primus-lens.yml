name: Primus-Lens-Build
on:
  push:
    branches:
      - '**'
    tags:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      image_version: ${{ steps.get-image-version.outputs.image_version }}
      date_time: ${{ steps.get-current-time.outputs.date_time }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Calculate ImageVersion
      id: get-image-version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
          echo "image_version=$TAG" >> $GITHUB_OUTPUT
        else
          echo "image_version=latest" >> $GITHUB_OUTPUT
        fi
    - name: Get Current Time
      id: get-current-time
      run: |
        FORMATTED_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d%H%M')
        echo "::set-output name=date_time::$FORMATTED_DATE"
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files_yaml: |
          api:
            - Lens/modules/api/**
            - Lens/modules/core/**
          jobs:
            - Lens/modules/jobs/**
            - Lens/modules/core/**
          node_exporter:
            - Lens/modules/exporters/node-exporter/**
            - Lens/modules/core/**
          telemetry_processor:
            - Lens/modules/telemetry-processor/**
            - Lens/modules/core/**
          gpu_resource_exporter:
            - Lens/modules/exporters/gpu-resource-exporter/**
            - Lens/modules/core/**
          system_tuner:
            - Lens/modules/system-tuner/**
          network_exporter:
            - Lens/modules/exporters/network-exporter/**
            - Lens/modules/core/**
          primus_safe_adapter:
            - Lens/modules/adapter/primus-safe-adapter/**
            - Lens/modules/core/**
    - name: Generate matrix
      id: generate-matrix
      run: |
          MATRIX='{"include":['
          if [[ "${{ steps.changed-files.outputs.api_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-api","buildpath":"cmd/primus-lens-api","basepath":"Lens/modules/api/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.jobs_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-jobs","buildpath":"cmd/primus-lens-jobs","basepath":"Lens/modules/jobs/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.node_exporter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-node-exporter","buildpath":"cmd/node-exporter","basepath":"Lens/modules/exporters/node-exporter/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.telemetry_processor_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"telemetry-processor","buildpath":"cmd/telemetry-processor","basepath":"Lens/modules/telemetry-processor/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.gpu_resource_exporter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"gpu-resource-exporter","buildpath":"cmd/gpu-resource-exporter","basepath":"Lens/modules/exporters/gpu-resource-exporter/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.system_tuner_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"system-tuner","buildpath":"cmd/system-tuner","basepath":"Lens/modules/system-tuner/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.network_exporter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-network-exporter","buildpath":"cmd/network-exporter","basepath":"Lens/modules/exporters/network-exporter/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.primus_safe_adapter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-safe-adapter","buildpath":"cmd/primus-safe-adapter","basepath":"Lens/modules/adapter/primus-safe-adapter/"},'
          fi
          MATRIX=${MATRIX%,} # remove trailing comma
          MATRIX+=']}'
          echo "Generated matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  build:
    needs: detect-changes
    runs-on: primus-safe-tw
    outputs:
      primary_tag: ${{ steps.build-and-push.outputs.primary_tag }}
    timeout-minutes: 7200
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    if: ${{ needs.detect-changes.outputs.matrix != '' && needs.detect-changes.outputs.matrix != '{"include":[]}' }}
    steps:
      - uses: actions/checkout@v4
      - name: Login registries
        run: |
          buildah login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}" docker.io
          buildah login --tls-verify=false -u "${{ secrets.HARBOR_USERNAME }}" -p "${{ secrets.HARBOR_PASSWORD }}" "${{ secrets.HARBOR_HOST }}"

      - name: Build and push with Buildah
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          HARBOR_REPOSITORY: ${{ secrets.HARBOR_HOST }}/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
        run: |
          set -e
          echo "ðŸš§ Building ${{ matrix.name }}..."

          buildah bud \
            --layers \
            --build-arg BUILDPATH=${{ matrix.buildpath }} \
            --build-arg BASEPATH=${{ matrix.basepath }} \
            --build-arg APPNAME=${{ matrix.name }} \
            --build-arg GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -t ${{ matrix.name }}:${IMAGE_VERSION} \
            -t ${{ matrix.name }}:latest \
            -f Lens/ci/Dockerfile .
          

          for repo in ${DOCKERIO_REPOSITORY} ${HARBOR_REPOSITORY}; do
            buildah tag ${{ matrix.name }}:${IMAGE_VERSION} ${repo}/${{ matrix.name }}:${IMAGE_VERSION}
            buildah tag ${{ matrix.name }}:latest ${repo}/${{ matrix.name }}:latest
            buildah push --tls-verify=false ${repo}/${{ matrix.name }}:${IMAGE_VERSION}
            buildah push --tls-verify=false ${repo}/${{ matrix.name }}:latest
          done


  
