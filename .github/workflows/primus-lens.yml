name: Primus-Lens-Build
on:
  push:
    branches:
      - '**'
    tags:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      image_version: ${{ steps.get-image-version.outputs.image_version }}
      date_time: ${{ steps.get-current-time.outputs.date_time }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Calculate ImageVersion
      id: get-image-version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
          echo "image_version=$TAG" >> $GITHUB_OUTPUT
        else
          echo "image_version=latest" >> $GITHUB_OUTPUT
        fi
    - name: Get Current Time
      id: get-current-time
      run: |
        FORMATTED_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d%H%M')
        echo "date_time=$FORMATTED_DATE" >> $GITHUB_OUTPUT
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files_yaml: |
          api:
            - Lens/modules/api/**
            - Lens/modules/core/**
          jobs:
            - Lens/modules/jobs/**
            - Lens/modules/core/**
          node_exporter:
            - Lens/modules/exporters/node-exporter/**
            - Lens/modules/core/**
          telemetry_processor:
            - Lens/modules/telemetry-processor/**
            - Lens/modules/core/**
            - Lens/modules/ai-advisor/pkg/client/**
          ai_advisor:
            - Lens/modules/ai-advisor/**
            - Lens/modules/core/**
          gpu_resource_exporter:
            - Lens/modules/exporters/gpu-resource-exporter/**
            - Lens/modules/core/**
          system_tuner:
            - Lens/modules/system-tuner/**
          network_exporter:
            - Lens/modules/exporters/network-exporter/**
            - Lens/modules/core/**
          primus_safe_adapter:
            - Lens/modules/adapter/primus-safe-adapter/**
            - Lens/modules/core/**
          multi_cluster_config_exporter:
            - Lens/modules/exporters/multi-cluster-config-exporter/**
            - Lens/modules/core/**
    - name: Generate matrix
      id: generate-matrix
      run: |
          MATRIX='{"include":['
          if [[ "${{ steps.changed-files.outputs.api_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-api","buildpath":"cmd/primus-lens-api","basepath":"Lens/modules/api/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.jobs_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-jobs","buildpath":"cmd/primus-lens-jobs","basepath":"Lens/modules/jobs/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.node_exporter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-node-exporter","buildpath":"cmd/node-exporter","basepath":"Lens/modules/exporters/node-exporter/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.telemetry_processor_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"telemetry-processor","buildpath":"cmd/telemetry-processor","basepath":"Lens/modules/telemetry-processor/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.ai_advisor_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"ai-advisor","buildpath":"cmd/ai-advisor","basepath":"Lens/modules/ai-advisor/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.gpu_resource_exporter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"gpu-resource-exporter","buildpath":"cmd/gpu-resource-exporter","basepath":"Lens/modules/exporters/gpu-resource-exporter/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.system_tuner_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"system-tuner","buildpath":"cmd/system-tuner","basepath":"Lens/modules/system-tuner/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.network_exporter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-lens-network-exporter","buildpath":"cmd/network-exporter","basepath":"Lens/modules/exporters/network-exporter/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.primus_safe_adapter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"primus-safe-adapter","buildpath":"cmd/primus-safe-adapter","basepath":"Lens/modules/adapter/primus-safe-adapter/"},'
          fi
          if [[ "${{ steps.changed-files.outputs.multi_cluster_config_exporter_any_changed }}" == "true" ]]; then
            MATRIX+='{"name":"multi-cluster-config-exporter","buildpath":"cmd/multi-cluster-config-exporter","basepath":"Lens/modules/exporters/multi-cluster-config-exporter/"},'
          fi
          MATRIX=${MATRIX%,} # remove trailing comma
          MATRIX+=']}'
          echo "Generated matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  
  output-version:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Display Image Version
        run: |
          echo "================================================"
          echo "ðŸ“¦ Image Version: ${{ needs.detect-changes.outputs.image_version }}"
          echo "ðŸ“… Build DateTime: ${{ needs.detect-changes.outputs.date_time }}"
          echo "================================================"
  
  build:
    needs: detect-changes
    runs-on: primus-safe-tw
    timeout-minutes: 7200
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    if: ${{ needs.detect-changes.outputs.matrix != '' && needs.detect-changes.outputs.matrix != '{"include":[]}' }}
    env:
      GO_VERSION: "1.24.7"  # Centralized Go version management
    steps:
      - uses: actions/checkout@v4
      - name: Login registries
        run: |
          buildah login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}" docker.io
          buildah login --tls-verify=false -u "${{ secrets.HARBOR_USERNAME }}" -p "${{ secrets.HARBOR_PASSWORD }}" "${{ secrets.HARBOR_HOST }}"

      - name: Build and push with Buildah
        env:
          DOCKERIO_REPOSITORY: docker.io/primussafe
          HARBOR_REPOSITORY: ${{ secrets.HARBOR_HOST }}/primussafe
          IMAGE_VERSION: ${{ needs.detect-changes.outputs.image_version }}
          DATE_TIME: ${{ needs.detect-changes.outputs.date_time }}
        run: |
          set -e
          echo "ðŸš§ Building ${{ matrix.name }}..."

          # Determine which Dockerfile to use
          # First check if module has its own Dockerfile in installer directory
          MODULE_DOCKERFILE="${{ matrix.basepath }}installer/Dockerfile"
          FALLBACK_DOCKERFILE="Lens/ci/Dockerfile"
          
          if [[ -f "$MODULE_DOCKERFILE" ]]; then
            DOCKERFILE="$MODULE_DOCKERFILE"
            echo "ðŸ“„ Using module-specific Dockerfile: $DOCKERFILE"
          else
            DOCKERFILE="$FALLBACK_DOCKERFILE"
            echo "ðŸ“„ Using fallback Dockerfile: $DOCKERFILE"
          fi

          buildah bud \
            --layers \
            --build-arg GO_VERSION=${{ env.GO_VERSION }} \
            --build-arg GOPROXY=${{ secrets.GOPROXY }},direct \
            --build-arg BUILDPATH=${{ matrix.buildpath }} \
            --build-arg BASEPATH=${{ matrix.basepath }} \
            --build-arg APPNAME=${{ matrix.name }} \
            --build-arg GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -t ${{ matrix.name }}:${IMAGE_VERSION} \
            -t ${{ matrix.name }}:${DATE_TIME} \
            -f ${DOCKERFILE} .
          

          for repo in ${DOCKERIO_REPOSITORY} ${HARBOR_REPOSITORY}; do
            echo "ðŸš€ Pushing ${{ matrix.name }} to $repo..."
            buildah tag ${{ matrix.name }}:${IMAGE_VERSION} ${repo}/${{ matrix.name }}:${IMAGE_VERSION}
            buildah tag ${{ matrix.name }}:${DATE_TIME} ${repo}/${{ matrix.name }}:${DATE_TIME}
            echo "Pushing tags: ${repo}/${{ matrix.name }}:${IMAGE_VERSION}"
            buildah push --tls-verify=false ${repo}/${{ matrix.name }}:${IMAGE_VERSION}
            echo "Pushing tags: ${repo}/${{ matrix.name }}:${DATE_TIME}"
            buildah push --tls-verify=false ${repo}/${{ matrix.name }}:${DATE_TIME}
          done


  
