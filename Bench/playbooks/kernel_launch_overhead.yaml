- hosts: all
  gather_facts: no
  vars:
    results: []
  tasks:
    - name: Run kernel_launch_overhead and capture output
      command: kernel_launch_overhead -w 100 -n 2000000 -i 2000
      register: overhead_result
      ignore_errors: yes
    - name: Write raw output to node-specific log
      copy:
        content: "{{ overhead_result.stdout }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}/kernel_launch.log"
      run_once: false
      delegate_to: localhost
    - name: Parse event and wall time
      set_fact:
        event_time: "{{ (overhead_result.stdout | regex_search('event time:\\s*([0-9.]+)\\s*ms', '\\1')) | float }}"
        wall_time: "{{ (overhead_result.stdout | regex_search('wall time:\\s*([0-9.]+)\\s*ms', '\\1')) | float }}"
    - name: Append node result to results list
      set_fact:
        results: "{{ results + [ { 'node': inventory_hostname, 'event_time_ms': event_time, 'wall_time_ms': wall_time } ] }}"
    - name: Show parsed results
      debug:
        var: results
    - name: Write aggregated results to JSON file (once)
      copy:
        content: "{{ results | to_json(indent=2) }}"
        dest: "{{ output_dir }}/kernel_overhead_results.json"
      run_once: true
      delegate_to: localhost

