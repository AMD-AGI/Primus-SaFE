- hosts: all
  gather_facts: no
  vars:
    results: []
  tasks:
    - name: Run kernel_launch_overhead
      command: kernel_launch_overhead -w 100 -n 2000000 -i 2000
      register: overhead_result
      ignore_errors: yes
    - name: Write raw output to node-specific log
      copy:
        content: "{{ overhead_result.stdout | default('No output') }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}/kernel_launch.log"
      delegate_to: localhost
    - name: Parse event & wall time safely
      set_fact:
        event_time: >-
          {{ (overhead_result.stdout | default('') | 
          regex_findall('event time[:：]\\s*([0-9.]+)\\s*ms') | first | default('0', true)) | float }}
        wall_time: >-
          {{ (overhead_result.stdout | default('') | 
          regex_findall('wall time[:：]\\s*([0-9.]+)\\s*ms') | first | default('0', true)) | float }}
    - name: Append result
      set_fact:
        results: "{{ results + [ {'node': inventory_hostname, 'event_time_ms': event_time, 'wall_time_ms': wall_time } ] }}"
    - name: Show results
      debug:
        var: results
    - name: Save aggregated results JSON once
      copy:
        content: "{{ results | to_nice_json }}"
        dest: "{{ output_dir }}/kernel_overhead_results.json"
      delegate_to: localhost
      run_once: true

