- hosts: all
  vars:
    workspace: '{{ workspace | default(/opt/primus-bench) }}'
  tasks:
    - name: Collect all node names from inventory
      set_fact:
        nodes: "{{ groups['all'] | list }}"
    - name: Run node check script
      shell: |
        ADD_LOG_HEADER=true \
        HF_TOKEN={{ hf_token }} \
        NNODES={{ nodes | length }} \
        WORLD_SIZE={{ nodes | length }} \
        LOCAL_WORLD_SIZE={{ nodes | length }} \
        RANK={{ nodes.index(inventory_hostname) }} \
        LOCAL_RANK={{ nodes.index(inventory_hostname) }} \
        NODE_RANK={{ nodes.index(inventory_hostname) }} \
        MASTER_ADDR={{ nodes | first }} \
        MASTER_PORT={{ master_port}} \
        bash run.sh  2>&1 | tee /tmp/node.log
      args:
        chdir: '{{ workspace }}/preflight/node'
      async: 0
      poll: 0
