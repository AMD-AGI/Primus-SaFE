- hosts: all
  gather_facts: true

  vars:
    workspace: "{{ workspace | default('/opt/primus-bench') }}"
    master_port: "{{ master_port | default('29500') }}"
    container_env: "{{ container_env | default({}) }}"

  tasks:
    - name: Collect all nodes from inventory
      set_fact:
        nodes: "{{ groups['all'] | list }}"

    - name: Build final environment (container_env + overrides)
      set_fact:
        final_env: >-
          {{
            container_env | combine({
              'ADD_LOG_HEADER': 'true',
              'NNODES': nodes|length,
              'WORLD_SIZE': nodes|length,
              'LOCAL_WORLD_SIZE': nodes|length,
              'RANK': nodes.index(inventory_hostname),
              'LOCAL_RANK': nodes.index(inventory_hostname),
              'NODE_RANK': nodes.index(inventory_hostname),
              'MASTER_ADDR': nodes|first,
              'MASTER_PORT': master_port
            })
          }}

    - name: Run script with full system ENV + overrides
      shell: |
        LOG={{ output_dir }}/$(hostname)
        mkdir -p $LOG
        echo ${LOG}
        bash run.sh 2>&1 | tee ${LOG}/node.log
      args:
        chdir: "{{ workspace }}/preflight/node"
        executable: /bin/bash
      environment: "{{ final_env }}"
