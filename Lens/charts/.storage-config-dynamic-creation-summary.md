# Storage Config Secret åŠ¨æ€åˆ›å»ºå®ç°æ€»ç»“

## âœ… å®ç°å®Œæˆ

æˆåŠŸå°† Storage Config Secret ä»é™æ€æ¨¡æ¿æ”¹ä¸ºåŠ¨æ€åˆ›å»ºï¼Œè‡ªåŠ¨ä» Operator ç®¡ç†çš„ Secret ä¸­è¯»å–å®é™…çš„å¯†ç å’Œå‡­æ®ã€‚

---

## ğŸ¯ æ”¹è¿›åŠ¨æœº

### é—®é¢˜
ä¹‹å‰çš„å®ç°ï¼š
- âŒ å¯†ç åœ¨ `values.yaml` ä¸­ç¡¬ç¼–ç 
- âŒ éœ€è¦æ‰‹åŠ¨é…ç½® PostgreSQL å’Œ OpenSearch çš„å¯†ç 
- âŒ å¯†ç å¯èƒ½è¢«æäº¤åˆ° Git
- âŒ ä¸ Operator è‡ªåŠ¨ç”Ÿæˆçš„å¯†ç ä¸åŒæ­¥

### è§£å†³æ–¹æ¡ˆ
æ–°çš„å®ç°ï¼š
- âœ… ä» Operator ç®¡ç†çš„ Secret åŠ¨æ€è¯»å–å¯†ç 
- âœ… æ— éœ€åœ¨ `values.yaml` ä¸­é…ç½®å¯†ç 
- âœ… è‡ªåŠ¨ç­‰å¾… Secret å°±ç»ª
- âœ… å®Œå…¨ç”± Operator ç®¡ç†å‡­æ®ï¼Œæ›´å®‰å…¨

---

## ğŸ“¦ å®ç°æ–¹å¼

### 1. åˆ›å»ºä¸“ç”¨ ServiceAccount

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {release}-storage-config-creator
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "15"
```

### 2. é…ç½® RBAC æƒé™

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {release}-storage-config-creator
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "update", "patch"]
```

**æƒé™è¯´æ˜**:
- `get`, `list`: è¯»å– Operator åˆ›å»ºçš„ Secret
- `create`, `update`, `patch`: åˆ›å»º/æ›´æ–° storage-config Secret

### 3. Job åŠ¨æ€åˆ›å»º Secret

```bash
# Job æ‰§è¡Œæµç¨‹
1. ç­‰å¾… PostgreSQL Secret å°±ç»ª
   kubectl get secret {release}-pguser-primus-lens

2. ç­‰å¾… OpenSearch Secret å°±ç»ª
   kubectl get secret {clusterName}-admin-password

3. è¯»å– PostgreSQL å‡­æ®
   - user, password, dbname, host, port

4. è¯»å– OpenSearch å‡­æ®
   - username, password

5. åˆ›å»º primus-lens-storage-config Secret
   - opensearch: JSON é…ç½®
   - prometheus: JSON é…ç½®
   - postgres: JSON é…ç½®
```

---

## ğŸ“‹ è¯»å–çš„ Secret æ¥æº

### 1. PostgreSQL Secret

**Secret åç§°**: `{release}-pguser-primus-lens`
- ç”± PGO (Crunchy PostgreSQL Operator) è‡ªåŠ¨åˆ›å»º
- åŒ…å«æ•°æ®åº“ç”¨æˆ·çš„å®Œæ•´å‡­æ®

**æ•°æ®ç»“æ„** (Base64 ç¼–ç ):
```yaml
data:
  user: cHJpbXVzLWxlbnM=          # primus-lens
  password: <auto-generated>       # è‡ªåŠ¨ç”Ÿæˆçš„å¼ºå¯†ç 
  dbname: cHJpbXVzLWxlbnM=         # primus-lens
  host: <service-fqdn>             # {release}-postgres-primary.{namespace}.svc
  port: NTQzMg==                   # 5432
  jdbc-uri: <connection-string>
  uri: <connection-string>
  verifier: <scram-verifier>
```

**è¯»å–å­—æ®µ**:
- `user` â†’ postgres.username
- `password` â†’ postgres.password
- `dbname` â†’ postgres.db_name
- `host` â†’ postgres.service (å·²åŒ…å« FQDN)
- `port` â†’ postgres.port

### 2. OpenSearch Secret

**Secret åç§°**: `{clusterName}-admin-password`
- ç”± OpenSearch Operator è‡ªåŠ¨åˆ›å»º
- åŒ…å«ç®¡ç†å‘˜ç”¨æˆ·å‡­æ®

**æ•°æ®ç»“æ„** (Base64 ç¼–ç ):
```yaml
data:
  username: YWRtaW4=    # admin
  password: YWRtaW4=    # admin (é»˜è®¤ï¼Œå¯é€šè¿‡ Operator é…ç½®ä¿®æ”¹)
```

**è¯»å–å­—æ®µ**:
- `username` â†’ opensearch.username
- `password` â†’ opensearch.password

---

## ğŸ”„ éƒ¨ç½²æµç¨‹

### å®Œæ•´æ—¶åºå›¾

```
Phase 3: åŸºç¡€è®¾æ–½ CR éƒ¨ç½² (Normal Resources)
â”œâ”€â”€ PostgreSQL CR éƒ¨ç½²
â”‚   â””â”€â”€ PGO åˆ›å»º: {release}-pguser-primus-lens Secret
â”œâ”€â”€ OpenSearch CR éƒ¨ç½²
â”‚   â””â”€â”€ OpenSearch Operator åˆ›å»º: {clusterName}-admin-password Secret
â””â”€â”€ VictoriaMetrics CR éƒ¨ç½²
    â†“
Phase 4: ç­‰å¾…åŸºç¡€è®¾æ–½å°±ç»ª (Hook weight 5)
    â†“
Phase 5: PostgreSQL åˆå§‹åŒ– (Hook weight 10)
    â†“
Phase 5+: Storage Config åˆ›å»º (Hook weight 15-16)
â”œâ”€â”€ ServiceAccount + RBAC åˆ›å»º (weight 15)
â””â”€â”€ Storage Config Creator Job (weight 16)
    â”œâ”€â”€ ç­‰å¾… PG Secret å­˜åœ¨ (æœ€å¤š 60 æ¬¡é‡è¯•)
    â”œâ”€â”€ ç­‰å¾… OS Secret å­˜åœ¨ (æœ€å¤š 60 æ¬¡é‡è¯•)
    â”œâ”€â”€ è¯»å– PG å‡­æ® (kubectl get secret ... | base64 -d)
    â”œâ”€â”€ è¯»å– OS å‡­æ® (kubectl get secret ... | base64 -d)
    â””â”€â”€ åˆ›å»º primus-lens-storage-config Secret
        â†“
Phase 6: åº”ç”¨ç»„ä»¶éƒ¨ç½² (Normal Resources)
â””â”€â”€ åº”ç”¨ç»„ä»¶è¯»å– primus-lens-storage-config Secret
```

### Hook Weight è¯´æ˜

| Phase | èµ„æº | Hook Weight | è¯´æ˜ |
|-------|------|-------------|------|
| 4 | wait-for-infrastructure | 5 | ç­‰å¾…åŸºç¡€è®¾æ–½ Pods |
| 5 | postgres-init | 10 | æ•°æ®åº“åˆå§‹åŒ– |
| 5+ | ServiceAccount/RBAC | 15 | åˆ›å»ºæƒé™ |
| 5+ | Storage Config Job | 16 | åˆ›å»ºé…ç½® Secret |
| 6 | åº”ç”¨ç»„ä»¶ | - | æ­£å¸¸èµ„æº |

---

## ğŸ“Š ç”Ÿæˆçš„ Secret ç»“æ„

### primus-lens-storage-config

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: primus-lens-storage-config
  namespace: primus-lens
type: Opaque
stringData:
  opensearch: |
    {
      "service": "primus-lens-logs",
      "port": 9200,
      "namespace": "primus-lens",
      "scheme": "https",
      "username": "admin",
      "password": "<ä» OS Secret è¯»å–>"
    }
  
  prometheus: |
    {
      "write_service": "vminsert-primus-lens-vmcluster",
      "write_port": 8480,
      "read_service": "vmselect-primus-lens-vmcluster",
      "read_port": 8481,
      "namespace": "primus-lens"
    }
  
  postgres: |
    {
      "service": "primus-lens-postgres-primary.primus-lens.svc",
      "port": 5432,
      "namespace": "primus-lens",
      "username": "primus_lens",
      "password": "<ä» PG Secret è¯»å–>",
      "db_name": "primus_lens",
      "ssl_mode": "require"
    }
```

---

## ğŸ”§ values.yaml å˜æ›´

### ç§»é™¤çš„é…ç½®

```yaml
# âŒ ä¸å†éœ€è¦
database:
  password: "changeme"

opensearch:
  adminPassword: "admin"
```

### æ›´æ–°åçš„é…ç½®

```yaml
database:
  enabled: true
  initScript: "setup_primus_lens.sql"
  # Note: Password is automatically generated by PGO and read from
  # the pguser secret, no need to configure here

opensearch:
  enabled: true
  clusterName: "primus-lens-logs"
  # Note: Admin password is read from the opensearch-operator-generated secret
  # No need to configure here, it will be automatically retrieved
  nodeSets: [...]
```

---

## ğŸ” å®‰å…¨ä¼˜åŠ¿

### 1. å¯†ç ç®¡ç†
- âœ… PGO è‡ªåŠ¨ç”Ÿæˆå¼ºéšæœºå¯†ç 
- âœ… å¯†ç ä¸ä¼šåœ¨ values.yaml ä¸­æš´éœ²
- âœ… å¯†ç ä¸ä¼šè¢«æäº¤åˆ° Git
- âœ… ç¬¦åˆæœ€ä½³å®‰å…¨å®è·µ

### 2. æƒé™æ§åˆ¶
- âœ… Job ä½¿ç”¨ä¸“ç”¨ ServiceAccount
- âœ… æœ€å°æƒé™åŸåˆ™ï¼ˆåªèƒ½è¯»å†™ Secretï¼‰
- âœ… RBAC é™åˆ¶åœ¨å•ä¸ª Namespace
- âœ… Job å®Œæˆåè‡ªåŠ¨æ¸…ç†ï¼ˆttl 300sï¼‰

### 3. å®¡è®¡è¿½è¸ª
- âœ… Job æ—¥å¿—è®°å½•æ‰€æœ‰æ“ä½œ
- âœ… Kubernetes Event è®°å½• Secret åˆ›å»º
- âœ… ä¾¿äºæ•…éšœæ’æŸ¥

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥ Operator Secret

```bash
# æ£€æŸ¥ PostgreSQL Secret
kubectl get secret primus-lens-pguser-primus-lens -n primus-lens
kubectl get secret primus-lens-pguser-primus-lens -n primus-lens -o jsonpath='{.data.password}' | base64 -d

# æ£€æŸ¥ OpenSearch Secret
kubectl get secret primus-lens-logs-admin-password -n primus-lens
kubectl get secret primus-lens-logs-admin-password -n primus-lens -o jsonpath='{.data.password}' | base64 -d
```

### 2. æ£€æŸ¥ Job æ‰§è¡Œ

```bash
# æŸ¥çœ‹ Job çŠ¶æ€
kubectl get job primus-lens-storage-config-creator -n primus-lens

# æŸ¥çœ‹ Job æ—¥å¿—
kubectl logs -n primus-lens job/primus-lens-storage-config-creator

# é¢„æœŸè¾“å‡ºï¼š
# === Creating Storage Config Secret ===
# Waiting for PostgreSQL secret: primus-lens-pguser-primus-lens
# Waiting for OpenSearch secret: primus-lens-logs-admin-password
# Reading PostgreSQL credentials from secret...
# Reading OpenSearch credentials from secret...
# Creating storage config secret: primus-lens-storage-config
# === Storage Config Secret created successfully ===
```

### 3. éªŒè¯ç”Ÿæˆçš„ Secret

```bash
# æ£€æŸ¥ storage-config Secret
kubectl get secret primus-lens-storage-config -n primus-lens

# æŸ¥çœ‹é…ç½®å†…å®¹
kubectl get secret primus-lens-storage-config -n primus-lens \
  -o jsonpath='{.data.opensearch}' | base64 -d | jq

kubectl get secret primus-lens-storage-config -n primus-lens \
  -o jsonpath='{.data.postgres}' | base64 -d | jq

kubectl get secret primus-lens-storage-config -n primus-lens \
  -o jsonpath='{.data.prometheus}' | base64 -d | jq
```

### 4. éªŒè¯å¯†ç ä¸€è‡´æ€§

```bash
# æ¯”è¾ƒ PG å¯†ç 
PG_ORIGINAL=$(kubectl get secret primus-lens-pguser-primus-lens -n primus-lens -o jsonpath='{.data.password}' | base64 -d)
PG_CONFIG=$(kubectl get secret primus-lens-storage-config -n primus-lens -o jsonpath='{.data.postgres}' | base64 -d | jq -r '.password')
echo "PG Passwords match: $([ "$PG_ORIGINAL" = "$PG_CONFIG" ] && echo 'YES' || echo 'NO')"

# æ¯”è¾ƒ OS å¯†ç 
OS_ORIGINAL=$(kubectl get secret primus-lens-logs-admin-password -n primus-lens -o jsonpath='{.data.password}' | base64 -d)
OS_CONFIG=$(kubectl get secret primus-lens-storage-config -n primus-lens -o jsonpath='{.data.opensearch}' | base64 -d | jq -r '.password')
echo "OS Passwords match: $([ "$OS_ORIGINAL" = "$OS_CONFIG" ] && echo 'YES' || echo 'NO')"
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Job ä¸€ç›´ç­‰å¾… Secret

**ç—‡çŠ¶**:
```
Waiting for PostgreSQL secret... (60/60)
ERROR: PostgreSQL secret not found after 60 attempts
```

**åŸå› **: PostgreSQL CR éƒ¨ç½²å¤±è´¥æˆ– PGO æœªåˆ›å»º Secret

**æ’æŸ¥**:
```bash
# æ£€æŸ¥ PostgreSQL CR çŠ¶æ€
kubectl get postgrescluster -n primus-lens

# æ£€æŸ¥ PGO Operator æ—¥å¿—
kubectl logs -n postgres-operator deployment/pgo

# æ£€æŸ¥ PostgreSQL Pods
kubectl get pods -n primus-lens -l postgres-operator.crunchydata.com/cluster=primus-lens
```

### é—®é¢˜ 2: Job æƒé™ä¸è¶³

**ç—‡çŠ¶**:
```
Error from server (Forbidden): secrets "xxx" is forbidden: User "system:serviceaccount:primus-lens:xxx" cannot get resource "secrets"
```

**åŸå› **: RBAC é…ç½®é”™è¯¯æˆ–æœªç”Ÿæ•ˆ

**æ’æŸ¥**:
```bash
# æ£€æŸ¥ ServiceAccount
kubectl get sa primus-lens-storage-config-creator -n primus-lens

# æ£€æŸ¥ Role
kubectl get role primus-lens-storage-config-creator -n primus-lens -o yaml

# æ£€æŸ¥ RoleBinding
kubectl get rolebinding primus-lens-storage-config-creator -n primus-lens -o yaml

# æµ‹è¯•æƒé™
kubectl auth can-i get secrets --as=system:serviceaccount:primus-lens:primus-lens-storage-config-creator -n primus-lens
```

### é—®é¢˜ 3: å¯†ç æ ¼å¼é”™è¯¯

**ç—‡çŠ¶**: åº”ç”¨ç»„ä»¶æ— æ³•è¿æ¥æ•°æ®åº“ï¼Œå¯†ç é”™è¯¯

**æ’æŸ¥**:
```bash
# æ£€æŸ¥ JSON æ ¼å¼
kubectl get secret primus-lens-storage-config -n primus-lens \
  -o jsonpath='{.data.postgres}' | base64 -d | jq .

# æ£€æŸ¥ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
kubectl get secret primus-lens-pguser-primus-lens -n primus-lens \
  -o jsonpath='{.data.password}' | base64 -d | od -c
```

---

## ğŸ“ æ›´æ–°çš„æ–‡ä»¶

### 1. Helm æ¨¡æ¿
- âœ… `templates/05-postgres-init/storage-config-secret.yaml`
  - ä»é™æ€ Secret æ¨¡æ¿æ”¹ä¸º Job + RBAC
  - çº¦ 140 è¡Œ Bash è„šæœ¬

### 2. é…ç½®æ–‡ä»¶
- âœ… `values.yaml`
  - ç§»é™¤ `database.password`
  - ç§»é™¤ `opensearch.adminPassword`
  - æ·»åŠ è¯´æ˜æ³¨é‡Š

### 3. æ–‡æ¡£
- âœ… `CHANGELOG.md` - è®°å½•åŠ¨æ€åˆ›å»ºå®ç°
- âœ… `.storage-config-dynamic-creation-summary.md` - æœ¬æ–‡æ¡£

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

- [x] ServiceAccount åˆ›å»º
- [x] Role/RoleBinding é…ç½®ï¼ˆSecret è¯»å†™æƒé™ï¼‰
- [x] Job ç­‰å¾… PostgreSQL Secret
- [x] Job ç­‰å¾… OpenSearch Secret
- [x] Job è¯»å– PG å‡­æ®ï¼ˆuser, password, dbname, host, portï¼‰
- [x] Job è¯»å– OS å‡­æ®ï¼ˆusername, passwordï¼‰
- [x] Job åˆ›å»º storage-config Secret
- [x] Secret JSON æ ¼å¼ç¬¦åˆ Go ç»“æ„ä½“
- [x] Hook weight æ­£ç¡®ï¼ˆ16ï¼Œåœ¨ postgres-init ä¹‹åï¼‰
- [x] Job è‡ªåŠ¨æ¸…ç†ï¼ˆttl 300sï¼‰
- [x] values.yaml ç§»é™¤å¯†ç é…ç½®
- [x] CHANGELOG æ›´æ–°
- [x] æ–‡æ¡£ç¼–å†™

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•éªŒè¯**
   - åœ¨å¼€å‘ç¯å¢ƒå®Œæ•´éƒ¨ç½²æµ‹è¯•
   - éªŒè¯æ‰€æœ‰åº”ç”¨ç»„ä»¶èƒ½æ­£ç¡®è¿æ¥å­˜å‚¨
   - æµ‹è¯•å¯†ç è½®æ¢åœºæ™¯

2. **å¢å¼ºåŠŸèƒ½**
   - æ·»åŠ  Secret å˜æ›´æ£€æµ‹ï¼Œè‡ªåŠ¨æ›´æ–° storage-config
   - æ”¯æŒè‡ªå®šä¹‰é‡è¯•æ¬¡æ•°å’Œé—´éš”
   - æ·»åŠ  Prometheus æŒ‡æ ‡å¯¼å‡º

3. **å¤šé›†ç¾¤æ”¯æŒ**
   - å®ç° `primus-lens-multi-storage-config` åŠ¨æ€åˆ›å»º
   - æ”¯æŒä»å¤šä¸ªé›†ç¾¤è¯»å–å‡­æ®
   - æ·»åŠ è·¨é›†ç¾¤è®¿é—®æ”¯æŒ

4. **å®‰å…¨åŠ å›º**
   - è€ƒè™‘ä½¿ç”¨ External Secrets Operator
   - é›†æˆ Vault æˆ–å…¶ä»–å¯†é’¥ç®¡ç†ç³»ç»Ÿ
   - å®ç°å¯†ç è‡ªåŠ¨è½®æ¢

---

**å®ç°æ—¶é—´**: 2024-12-04  
**ç‰ˆæœ¬**: v2.0 (åŠ¨æ€åˆ›å»º)  
**çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…éªŒè¯

