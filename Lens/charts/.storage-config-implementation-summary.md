# Storage Config Secret å®ç°æ€»ç»“

## âœ… å®ç°å®Œæˆ

å·²æˆåŠŸåˆ›å»º `primus-lens-storage-config` Secretï¼Œç”¨äºé›†ä¸­ç®¡ç†å­˜å‚¨åç«¯è¿æ¥é…ç½®ã€‚

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶

### 1. Helm æ¨¡æ¿
- âœ… `templates/05-postgres-init/storage-config-secret.yaml` (1.8 KB)
  - Secret å®šä¹‰ï¼ŒåŒ…å« opensearchã€prometheusã€postgres ä¸‰ä¸ªé…ç½®

### 2. æ–‡æ¡£
- âœ… `STORAGE_CONFIG_SECRET.md` (è¯¦ç»†è¯´æ˜æ–‡æ¡£)
  - Secret ç»“æ„è¯´æ˜
  - ä½¿ç”¨æ–¹å¼
  - æ•…éšœæ’æŸ¥
  - éƒ¨ç½²ç¤ºä¾‹

### 3. é…ç½®æ›´æ–°
- âœ… `values.yaml`
  - æ–°å¢ `database.password` é…ç½®
  - æ–°å¢ `opensearch.adminPassword` é…ç½®

### 4. å˜æ›´æ—¥å¿—
- âœ… `CHANGELOG.md` (æ›´æ–°)
  - è®°å½• Storage Config Secret å®ç°

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. Secret ç»“æ„

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: primus-lens-storage-config
  namespace: primus-lens
type: Opaque
stringData:
  opensearch: |
    { "service": "...", "port": 9200, ... }
  prometheus: |
    { "write_service": "...", "read_service": "...", ... }
  postgres: |
    { "service": "...", "port": 5432, ... }
```

### 2. é…ç½®æ˜ å°„

| Secret é”® | Go ç»“æ„ä½“ | ç”¨é€” |
|-----------|-----------|------|
| `opensearch` | `PrimusLensClientConfigOpensearch` | OpenSearch æ—¥å¿—å­˜å‚¨è¿æ¥ |
| `prometheus` | `PrimusLensClientConfigPrometheus` | VictoriaMetrics æŒ‡æ ‡å­˜å‚¨è¿æ¥ |
| `postgres` | `PrimusLensClientConfigPostgres` | PostgreSQL æ•°æ®åº“è¿æ¥ |

### 3. éƒ¨ç½²æ—¶æœº

```
Phase 5: PostgreSQL åˆå§‹åŒ– (weight 10)
    â†“
Phase 5+: Storage Config Secret åˆ›å»º (weight 15) â† å½“å‰å®ç°
    â†“
Phase 6: åº”ç”¨ç»„ä»¶éƒ¨ç½²ï¼ˆè¯»å–æ­¤ Secretï¼‰
```

---

## ğŸ”§ values.yaml é…ç½®

### æ–°å¢é…ç½®é¡¹

```yaml
# PostgreSQL é…ç½®
database:
  enabled: true
  initScript: "setup_primus_lens.sql"
  password: "changeme"  # âš ï¸ ç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹

# OpenSearch é…ç½®
opensearch:
  enabled: true
  clusterName: "primus-lens-logs"
  adminPassword: "admin"  # âš ï¸ ç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹
  nodeSets:
    - name: "nodes"
      replicas: 3
      roles: [master, data, ingest]
```

### è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®

VictoriaMetrics é…ç½®æ— éœ€é¢å¤–é…ç½®ï¼Œè‡ªåŠ¨ä»å‘½åçº¦å®šç”Ÿæˆï¼š
- Write Service: `vminsert-{release-name}-vmcluster`
- Read Service: `vmselect-{release-name}-vmcluster`

---

## ğŸ“Š JSON å­—æ®µæ˜ å°„

### OpenSearch

| JSON å­—æ®µ | Go å­—æ®µ | ç¤ºä¾‹å€¼ |
|-----------|---------|--------|
| `service` | `Service` | `primus-lens-logs` |
| `port` | `Port` | `9200` |
| `namespace` | `Namespace` | `primus-lens` |
| `scheme` | `Scheme` | `https` |
| `username` | `Username` | `admin` |
| `password` | `Password` | `admin` |

### Prometheus/VictoriaMetrics

| JSON å­—æ®µ | Go å­—æ®µ | ç¤ºä¾‹å€¼ |
|-----------|---------|--------|
| `write_service` | `WriteService` | `vminsert-primus-lens-vmcluster` |
| `write_port` | `WritePort` | `8480` |
| `read_service` | `ReadService` | `vmselect-primus-lens-vmcluster` |
| `read_port` | `ReadPort` | `8481` |
| `namespace` | `Namespace` | `primus-lens` |

### PostgreSQL

| JSON å­—æ®µ | Go å­—æ®µ | ç¤ºä¾‹å€¼ |
|-----------|---------|--------|
| `service` | `Service` | `primus-lens-postgres-primary` |
| `port` | `Port` | `5432` |
| `namespace` | `Namespace` | `primus-lens` |
| `username` | `Username` | `primus_lens` |
| `password` | `Password` | `changeme` |
| `db_name` | `DBName` | `primus_lens` |
| `ssl_mode` | `SSLMode` | `require` |

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åœ¨ Go ä»£ç ä¸­è¯»å–

```go
import (
    "context"
    "github.com/AMD-AGI/Primus-SaFE/Lens/core/pkg/clientsets"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

func loadStorageConfig(ctx context.Context, k8sClient *kubernetes.Clientset) error {
    // è¯»å– Secret
    secret, err := k8sClient.CoreV1().Secrets("primus-lens").Get(
        ctx,
        "primus-lens-storage-config",
        metav1.GetOptions{},
    )
    if err != nil {
        return err
    }

    // åŠ è½½é…ç½®
    cfg := &clientsets.PrimusLensClientConfig{}
    if err := cfg.LoadFromSecret(secret.Data); err != nil {
        return err
    }

    // ä½¿ç”¨é…ç½®åˆå§‹åŒ–å®¢æˆ·ç«¯
    storageClients, err := clientsets.InitStorageClients(ctx, "current", *cfg)
    if err != nil {
        return err
    }

    // ä½¿ç”¨å­˜å‚¨å®¢æˆ·ç«¯
    db := storageClients.DB
    opensearch := storageClients.OpenSearch
    prometheusRead := storageClients.PrometheusRead
    prometheusWrite := storageClients.PrometheusWrite

    return nil
}
```

### ä½¿ç”¨ ClusterManagerï¼ˆæ¨èï¼‰

```go
import "github.com/AMD-AGI/Primus-SaFE/Lens/core/pkg/clientsets"

// è·å–å½“å‰é›†ç¾¤çš„å­˜å‚¨å®¢æˆ·ç«¯
storageClients := clientsets.GetClusterManager().
    GetCurrentClusterClients().
    StorageClientSet

// ç›´æ¥ä½¿ç”¨
db := storageClients.DB
opensearch := storageClients.OpenSearch
```

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. éƒ¨ç½²éªŒè¯

```bash
# éƒ¨ç½² Helm Chart
helm install primus-lens ./Lens/charts \
  --namespace primus-lens \
  --create-namespace \
  --set database.password="test-password" \
  --set opensearch.adminPassword="test-password"

# ç­‰å¾…æ‰€æœ‰ Pod å°±ç»ª
kubectl wait --for=condition=ready pod --all -n primus-lens --timeout=10m
```

### 2. Secret éªŒè¯

```bash
# æ£€æŸ¥ Secret æ˜¯å¦å­˜åœ¨
kubectl get secret primus-lens-storage-config -n primus-lens

# æŸ¥çœ‹ Secret å†…å®¹
kubectl get secret primus-lens-storage-config -n primus-lens -o yaml

# è§£ç å¹¶æŸ¥çœ‹ opensearch é…ç½®
kubectl get secret primus-lens-storage-config -n primus-lens \
  -o jsonpath='{.data.opensearch}' | base64 -d | jq

# è§£ç å¹¶æŸ¥çœ‹ prometheus é…ç½®
kubectl get secret primus-lens-storage-config -n primus-lens \
  -o jsonpath='{.data.prometheus}' | base64 -d | jq

# è§£ç å¹¶æŸ¥çœ‹ postgres é…ç½®
kubectl get secret primus-lens-storage-config -n primus-lens \
  -o jsonpath='{.data.postgres}' | base64 -d | jq
```

### 3. JSON æ ¼å¼éªŒè¯

```bash
# éªŒè¯æ‰€æœ‰é…ç½®çš„ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®
for key in opensearch prometheus postgres; do
  echo "=== Validating $key ==="
  kubectl get secret primus-lens-storage-config -n primus-lens \
    -o jsonpath="{.data.$key}" | base64 -d | jq . || echo "âŒ Invalid JSON"
done
```

### 4. æœåŠ¡è¿æ¥éªŒè¯

```bash
# éªŒè¯ OpenSearch æœåŠ¡
kubectl run -it --rm debug --image=curlimages/curl --restart=Never -- \
  curl -k -u admin:admin https://primus-lens-logs.primus-lens:9200

# éªŒè¯ VictoriaMetrics æœåŠ¡
kubectl run -it --rm debug --image=curlimages/curl --restart=Never -- \
  curl http://vmselect-primus-lens-vmcluster.primus-lens:8481/api/v1/query?query=up

# éªŒè¯ PostgreSQL æœåŠ¡
kubectl run -it --rm debug --image=postgres:15 --restart=Never -- \
  psql -h primus-lens-postgres-primary.primus-lens -U primus_lens -d primus_lens -c "SELECT version();"
```

---

## ğŸ” å®‰å…¨æ£€æŸ¥æ¸…å•

- [x] Secret ç±»å‹è®¾ç½®ä¸º `Opaque`
- [x] å¯†ç ä» `values.yaml` åŠ¨æ€è¯»å–
- [x] æ”¯æŒé€šè¿‡ `--set` è¦†ç›–å¯†ç 
- [x] æ–‡æ¡£ä¸­å¼ºè°ƒç”Ÿäº§ç¯å¢ƒä¿®æ”¹é»˜è®¤å¯†ç 
- [x] PostgreSQL ä½¿ç”¨ SSL (`ssl_mode: require`)
- [x] OpenSearch ä½¿ç”¨ HTTPS (`scheme: https`)
- [ ] TODO: é…ç½® RBAC é™åˆ¶ Secret è®¿é—®
- [ ] TODO: è€ƒè™‘é›†æˆå¤–éƒ¨å¯†é’¥ç®¡ç†ï¼ˆVaultï¼‰

---

## ğŸŒ å¤šé›†ç¾¤æ”¯æŒï¼ˆå¾…å®ç°ï¼‰

å½“å‰å®ç°æ”¯æŒå•é›†ç¾¤é…ç½®ã€‚å¯¹äºå¤šé›†ç¾¤åœºæ™¯ï¼Œéœ€è¦ï¼š

1. åˆ›å»º `primus-lens-multi-storage-config` Secret
2. æ ¼å¼ä¸ºï¼šæ¯ä¸ªé”®æ˜¯é›†ç¾¤åï¼Œå€¼æ˜¯è¯¥é›†ç¾¤çš„å­˜å‚¨é…ç½®ï¼ˆåŒé‡ç¼–ç ï¼‰
3. åº”ç”¨ç»„ä»¶é€šè¿‡ `PrimusLensMultiClusterClientConfig` åŠ è½½

**ç¤ºä¾‹ç»“æ„**:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: primus-lens-multi-storage-config
stringData:
  cluster1: |
    {
      "opensearch": "<base64(json)>",
      "prometheus": "<base64(json)>",
      "postgres": "<base64(json)>"
    }
  cluster2: |
    { ... }
```

---

## ğŸ“š ç›¸å…³ä»£ç æ–‡ä»¶

### Go ä»£ç 
- `Lens/modules/core/pkg/clientsets/secret_template.go`
  - `PrimusLensClientConfig` ç»“æ„ä½“å®šä¹‰
  - `PrimusLensClientConfigOpensearch`
  - `PrimusLensClientConfigPrometheus`
  - `PrimusLensClientConfigPostgres`
  - `LoadFromSecret()` æ–¹æ³•

- `Lens/modules/core/pkg/clientsets/storage.go`
  - `StorageClientSet` ç»“æ„ä½“
  - `loadSingleClusterStorageConfig()`
  - `loadMultiClusterStorageConfig()`
  - `initStorageClients()`

- `Lens/modules/core/pkg/clientsets/multicluster.go`
  - Secret åç§°å¸¸é‡å®šä¹‰
  - `StorageConfigSecretName`
  - `MultiStorageConfigSecretName`

### Helm æ¨¡æ¿
- `templates/05-postgres-init/storage-config-secret.yaml`
- `templates/03-infrastructure/opensearch-cr.yaml`
- `templates/03-infrastructure/vmcluster.yaml`
- `templates/03-infrastructure/pg-cr.yaml`

### é…ç½®æ–‡ä»¶
- `values.yaml`
- `Chart.yaml`

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

- [x] Secret æ¨¡æ¿åˆ›å»ºå®Œæˆ
- [x] values.yaml é…ç½®é¡¹æ·»åŠ å®Œæˆ
- [x] JSON å­—æ®µåä¸ Go struct tag åŒ¹é…
- [x] éƒ¨ç½²é¡ºåºæ­£ç¡®ï¼ˆweight 15ï¼Œåœ¨ postgres-init ä¹‹åï¼‰
- [x] Secret ä½¿ç”¨ post-install å’Œ post-upgrade hook
- [x] è¯¦ç»†æ–‡æ¡£ç¼–å†™å®Œæˆ
- [x] CHANGELOG æ›´æ–°å®Œæˆ
- [x] OpenSearch service åç§°æ­£ç¡®
- [x] VictoriaMetrics service åç§°æ­£ç¡®
- [x] PostgreSQL service åç§°æ­£ç¡®
- [x] æ‰€æœ‰å¯†ç å­—æ®µå¯é…ç½®
- [x] SSL/TLS é…ç½®æ­£ç¡®

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•éªŒè¯**
   - åœ¨å¼€å‘ç¯å¢ƒéƒ¨ç½²å¹¶éªŒè¯
   - æµ‹è¯•åº”ç”¨ç»„ä»¶æ˜¯å¦èƒ½æ­£ç¡®è¯»å– Secret
   - éªŒè¯å­˜å‚¨å®¢æˆ·ç«¯åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ

2. **RBAC é…ç½®**
   - åˆ›å»º Role/ClusterRole é™åˆ¶ Secret è®¿é—®
   - ä¸ºåº”ç”¨ç»„ä»¶é…ç½® ServiceAccount
   - ç»‘å®šå¿…è¦çš„æƒé™

3. **å¤šé›†ç¾¤æ”¯æŒ**
   - å®ç° `primus-lens-multi-storage-config` Secret æ¨¡æ¿
   - æ·»åŠ å¤šé›†ç¾¤é…ç½®åˆ° values.yaml
   - æ›´æ–°æ–‡æ¡£è¯´æ˜å¤šé›†ç¾¤ä½¿ç”¨æ–¹å¼

4. **å¯†é’¥ç®¡ç†å¢å¼º**
   - è€ƒè™‘é›†æˆ Vault æˆ–å…¶ä»–å¯†é’¥ç®¡ç†ç³»ç»Ÿ
   - å®ç°å¯†ç è‡ªåŠ¨è½®æ¢æœºåˆ¶
   - æ·»åŠ å¯†é’¥åŠ å¯†ï¼ˆä½¿ç”¨ sealed-secrets æˆ–ç±»ä¼¼å·¥å…·ï¼‰

5. **ç›‘æ§å’Œå‘Šè­¦**
   - æ·»åŠ  Secret å­˜åœ¨æ€§æ£€æŸ¥
   - ç›‘æ§å­˜å‚¨è¿æ¥å¥åº·çŠ¶æ€
   - é…ç½®è¿æ¥å¤±è´¥å‘Šè­¦

---

**å®ç°æ—¶é—´**: 2024-12-04  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…éªŒè¯

