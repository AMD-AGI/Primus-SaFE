#
# Primus Lens Data Plane - Default Configuration Values
# 
# This chart deploys infrastructure components and data plane applications.
# Control plane (API, Adapter) should be deployed separately via primus-lens-apps-control-plane.
#

# ============================================================================
# Global Configuration
# ============================================================================
global:
  # Cluster identification
  clusterName: "my-cluster"  # Must be lowercase, alphanumeric or '-', max 16 chars
  namespace: "primus-lens"
  
  # Storage configuration
  storageClass: "local-path"
  accessMode: "ReadWriteOnce"  # Use "ReadWriteMany" if your storage supports it
  
  # Image registry settings
  imageRegistry: "docker.io"
  
  # Image pull secrets configuration
  # Leave credentials empty to create placeholder secret (update manually after deployment)
  imagePullSecrets:
    - name: primus-lens-image
      credentials:
        registry: "docker.io"
        username: ""  # Set via --set or keep empty for placeholder
        password: ""  # Set via --set or keep empty for placeholder
  
  # Access configuration
  accessType: "ssh-tunnel"  # Options: "ssh-tunnel" or "ingress"
  domain: "lens-primus.ai"  # Used when accessType is "ingress"

# ============================================================================
# Resource Profile Selection
# Choose profile based on your cluster size:
# - minimal: Small clusters, testing environments
# - normal: Production clusters with moderate workloads
# - large: Large-scale production clusters with high workloads
# ============================================================================
profile: "minimal"

profiles:
  minimal:
    opensearch:
      diskSize: "30Gi"
      memory: "2Gi"
      cpu: "1000m"
    postgres:
      backupSize: "10Gi"
      dataSize: "20Gi"
      replicas: 1
    victoriametrics:
      vmagent:
        cpu: "500m"
        memory: "512Mi"
      vmstorage:
        replicas: 1
        cpu: "1000m"
        memory: "2Gi"
        size: "30Gi"
      vmselect:
        replicas: 1
        cpu: "500m"
        memory: "1Gi"
      vminsert:
        replicas: 1
        cpu: "500m"
        memory: "1Gi"
  
  normal:
    opensearch:
      diskSize: "50Gi"
      memory: "4Gi"
      cpu: "2000m"
    postgres:
      backupSize: "20Gi"
      dataSize: "50Gi"
      replicas: 2
    victoriametrics:
      vmagent:
        cpu: "1000m"
        memory: "1Gi"
      vmstorage:
        replicas: 2
        cpu: "2000m"
        memory: "4Gi"
        size: "50Gi"
      vmselect:
        replicas: 2
        cpu: "1000m"
        memory: "2Gi"
      vminsert:
        replicas: 2
        cpu: "1000m"
        memory: "2Gi"
  
  large:
    opensearch:
      diskSize: "100Gi"
      memory: "8Gi"
      cpu: "4000m"
    postgres:
      backupSize: "50Gi"
      dataSize: "100Gi"
      replicas: 3
    victoriametrics:
      vmagent:
        cpu: "2000m"
        memory: "2Gi"
      vmstorage:
        replicas: 3
        cpu: "4000m"
        memory: "8Gi"
        size: "100Gi"
      vmselect:
        replicas: 3
        cpu: "2000m"
        memory: "4Gi"
      vminsert:
        replicas: 3
        cpu: "2000m"
        memory: "4Gi"

# ============================================================================
# Application Components (Data Plane only)
# ============================================================================
apps:
  enabled: true

# ============================================================================
# Data Plane Configuration (primus-lens-apps-dataplane sub-chart)
# Components: Telemetry, Jobs, Exporters, Web, AI Advisor
# ============================================================================
primus-lens-apps-dataplane:
  global:
    clusterName: "tas"
    namespace: "primus-lens"
    imageRegistry:
      url: "docker.io"
      pullPolicy: "IfNotPresent"
      pullSecret: ""
    tracing:
      enabled: false
  
  infrastructure:
    waitForPostgres: true
  
  apps:
    telemetryCollector:
      enabled: true
      image: "primussafe/telemetry-processor:202512101641"
      replicas: 1
      httpPort: 8989
      prometheusPort: 8990
      resources: {}
    
    jobs:
      enabled: true
      image: "primussafe/primus-lens-jobs:202512101526"
      replicas: 1
      httpPort: 8989
      grpcPort: 8991
      resources: {}
      config:
        environment: "production"
        prometheusPort: 8990
        controller:
          leaderElectionId: "primus-lens-core"
          metricsPort: 19193
          healthzPort: 19194
          pprofPort: 19195
    
    nodeExporter:
      enabled: true
      image: "primussafe/primus-lens-node-exporter:202512101526"
      httpPort: 8989
      maxUnavailable: 10
      resources: {}
    
    gpuResourceExporter:
      enabled: true
      image: "primussafe/gpu-resource-exporter:202512101526"
      replicas: 1
      httpPort: 8989
      grpcPort: 8991
      resources: {}
      config:
        loadK8SClient: true
        loadStorageClient: true
        prometheusPort: 8990
        controller:
          leaderElectionId: "primus-lens-gpu-resource"
          metricsPort: 19193
          healthzPort: 19194
          pprofPort: 19195
    
    systemTuner:
      enabled: true
      image: "primussafe/system-tuner:202512101526"
      resources:
        requests:
          cpu: "100m"
          memory: "128Mi"
        limits:
          cpu: "200m"
          memory: "256Mi"
    
    web:
      enabled: true
      image: "primussafe/primus-lens-web:202512091046"
      replicas: 1
      containerPort: 80
      resources: {}
      service:
        port: 80
    
    aiAdvisor:
      enabled: true
      image: "primussafe/ai-advisor:202512101630"
      replicas: 1
      httpPort: 8080
      healthPort: 8081
      logLevel: "info"
      resources:
        requests:
          cpu: "2000m"
          memory: "2Gi"
        limits:
          cpu: "2000m"
          memory: "2Gi"
      config:
        middleware:
          enableLogging: false
  
  serviceAccount:
    create: false
    name: "primus-lens-app"

# ============================================================================
# Database Configuration
# ============================================================================
database:
  enabled: true
  # PostgreSQL initialization SQL script
  initScript: "setup_primus_lens.sql"
  # Note: Password is automatically generated by PGO and read from
  # the pguser secret, no need to configure here

# ============================================================================
# OpenSearch Configuration (Log Storage)
# ============================================================================
opensearch:
  enabled: true
  clusterName: "primus-lens-logs"
  # Note: Admin password is read from the opensearch-operator-generated secret
  # No need to configure here, it will be automatically retrieved
  nodeSets:
    - name: "nodes"
      replicas: 3
      roles:
        - master
        - data
        - ingest

# ============================================================================
# VictoriaMetrics Configuration (Metrics Storage)
# ============================================================================
victoriametrics:
  enabled: true

# ============================================================================
# Logging Configuration
# ============================================================================
logging:
  enabled: true
  fluentbit:
    outputs:
      opensearch:
        enabled: true

# ============================================================================
# Grafana Configuration
# ============================================================================
grafana:
  enabled: true
  adminPassword: "admin"  # Change this in production!
  # Dashboards to import automatically
  dashboards:
    enabled: true
    folders:
      - name: "Default"
        dashboards:
          - node-history
          - node-stat
          - workload-metrics
      - name: "Node"
        dashboards:
          - node-exporter
          - node-rdma
      - name: "Kubernetes"
        dashboards:
          - k8s-overview
          - kubernetes-nodes
          - etcd-cluster-overview
      - name: "Middleware"
        dashboards:
          - opensearch-prometheus
          - victoriametrics-cluster
          - victoriametrics-operator
          - victoriametrics-vmagent

# ============================================================================
# Monitoring Configuration
# ============================================================================
monitoring:
  kubeStateMetrics:
    enabled: true

# ============================================================================
# Ingress Configuration
# ============================================================================
ingress:
  enabled: false  # Automatically set based on global.accessType
  className: "nginx"
  annotations: {}
  tls:
    enabled: true
    secretName: "primus-lens-tls"

# ============================================================================
# Operator Configurations (Sub-charts)
# These values are passed to the respective operator charts
# ============================================================================

# VictoriaMetrics Operator
vm-operator:
  enabled: true
  operator:
    enable_converter_ownership: true
    resources:
      limits:
        cpu: 200m
        memory: 150Mi
      requests:
        cpu: 50m
        memory: 100Mi

# Fluent Operator
fluent-operator:
  enabled: true
  operator:
    resources:
      limits:
        cpu: 200m
        memory: 200Mi
      requests:
        cpu: 50m
        memory: 100Mi

# OpenSearch Operator
opensearch-operator:
  enabled: true
  manager:
    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 128Mi

# PostgreSQL Operator (PGO)
pgo:
  enabled: true
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

# Grafana Operator
grafana-operator:
  enabled: true
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

# Kube State Metrics
kube-state-metrics:
  enabled: true
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi
