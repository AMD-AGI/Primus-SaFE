{{/*
OpenSearch Cluster Custom Resource
Defines the OpenSearch cluster for log storage and search.
*/}}
{{- if .Values.opensearch.enabled }}
{{- $profile := include "primus-lens-infra.profileConfig" . | fromYaml }}
apiVersion: opensearch.opster.io/v1
kind: OpenSearchCluster
metadata:
  name: {{ .Values.opensearch.clusterName }}
  namespace: {{ include "primus-lens-infra.namespace" . }}
  labels:
    {{- include "primus-lens-infra.labels" . | nindent 4 }}
    app.kubernetes.io/component: log-storage
spec:
  general:
    serviceName: {{ .Values.opensearch.clusterName }}
    version: "2.11.0"
    httpPort: 9200
    
    # Security configuration
    security:
      config:
        adminCredentialsSecret:
          name: {{ .Values.opensearch.clusterName }}-admin-password
  
  # Dashboard configuration (OpenSearch Dashboards)
  dashboards:
    enable: true
    replicas: 1
    version: "2.11.0"
    
    resources:
      requests:
        cpu: "200m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "2Gi"
  
  # Node pools configuration
  nodePools:
    {{- range .Values.opensearch.nodeSets }}
    - component: {{ .name }}
      replicas: {{ .replicas }}
      
      # Node roles
      roles:
        {{- range .roles }}
        - {{ . }}
        {{- end }}
      
      # Disk configuration
      diskSize: {{ $profile.opensearch.diskSize }}
      
      # Resource limits
      resources:
        requests:
          cpu: {{ $profile.opensearch.cpu }}
          memory: {{ $profile.opensearch.memory }}
        limits:
          cpu: {{ $profile.opensearch.cpu }}
          memory: {{ $profile.opensearch.memory }}
      
      # JVM configuration
      jvm: "-Xmx{{ div (include "primus-lens-infra.memoryToMi" $profile.opensearch.memory | int) 2 }}m -Xms{{ div (include "primus-lens-infra.memoryToMi" $profile.opensearch.memory | int) 2 }}m"
      
      # Persistence
      persistence:
        pvc:
          storageClass: {{ include "primus-lens-infra.storageClass" $ }}
          accessModes:
            - {{ include "primus-lens-infra.accessMode" $ }}
      
      # Anti-affinity for high availability
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                topologyKey: kubernetes.io/hostname
                labelSelector:
                  matchLabels:
                    opensearch.cluster.name: {{ $.Values.opensearch.clusterName }}
    {{- end }}
{{- end }}
---
{{/*
OpenSearch Admin Password Secret
*/}}
{{- if .Values.opensearch.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.opensearch.clusterName }}-admin-password
  namespace: {{ include "primus-lens-infra.namespace" . }}
  labels:
    {{- include "primus-lens-infra.labels" . | nindent 4 }}
type: Opaque
stringData:
  username: admin
  password: {{ randAlphaNum 32 | quote }}
{{- end }}

