{{- if .Values.systemTuner.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "primus-lens.fullname" . }}-wait-system-tuner
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "primus-lens.labels" . | nindent 4 }}
    app.kubernetes.io/component: system-tuner-waiter
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "primus-lens.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: system-tuner-waiter
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "primus-lens.serviceAccountName" . }}
      containers:
      - name: waiter
        image: bitnami/kubectl:1.28
        command:
        - /bin/bash
        - -c
        - |
          set -ex
          
          echo "Waiting for System Tuner to be ready on all nodes..."
          
          # 等待 System Tuner DaemonSet 就绪
          kubectl rollout status daemonset/{{ include "primus-lens.fullname" . }}-system-tuner \
            -n {{ .Values.global.namespace }} \
            --timeout=180s
          
          echo "✅ System Tuner is ready on all nodes"
          
          # 验证系统参数已设置
          echo "Verifying system parameters..."
          
          # 检查 vm.max_map_count
          DESIRED_VM_MAX_MAP_COUNT={{ .Values.systemTuner.parameters.vmMaxMapCount }}
          CURRENT_VM_MAX_MAP_COUNT=$(sysctl -n vm.max_map_count 2>/dev/null || echo "0")
          
          if [ "$CURRENT_VM_MAX_MAP_COUNT" -ge "$DESIRED_VM_MAX_MAP_COUNT" ]; then
            echo "✅ vm.max_map_count is set to $CURRENT_VM_MAX_MAP_COUNT"
          else
            echo "⚠️  Warning: vm.max_map_count is $CURRENT_VM_MAX_MAP_COUNT, expected >= $DESIRED_VM_MAX_MAP_COUNT"
          fi
          
          echo "✅ System tuning completed successfully"
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

