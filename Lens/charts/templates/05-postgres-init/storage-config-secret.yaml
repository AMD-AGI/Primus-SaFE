{{/*
Primus Lens Storage Config Secret Creation Job
Dynamically creates storage config by reading passwords from operator-managed secrets
This Job runs after PostgreSQL and OpenSearch are initialized
*/}}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "lens.fullname" . }}-storage-config-creator
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "lens.labels" . | nindent 4 }}
    app.kubernetes.io/component: storage-config
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "15"
    "helm.sh/hook-delete-policy": before-hook-creation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "lens.fullname" . }}-storage-config-creator
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "lens.labels" . | nindent 4 }}
    app.kubernetes.io/component: storage-config
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "15"
    "helm.sh/hook-delete-policy": before-hook-creation
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "lens.fullname" . }}-storage-config-creator
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "lens.labels" . | nindent 4 }}
    app.kubernetes.io/component: storage-config
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "15"
    "helm.sh/hook-delete-policy": before-hook-creation
subjects:
  - kind: ServiceAccount
    name: {{ include "lens.fullname" . }}-storage-config-creator
    namespace: {{ .Values.global.namespace }}
roleRef:
  kind: Role
  name: {{ include "lens.fullname" . }}-storage-config-creator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "lens.fullname" . }}-storage-config-creator
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "lens.labels" . | nindent 4 }}
    app.kubernetes.io/component: storage-config
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "16"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    metadata:
      labels:
        {{- include "lens.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: storage-config
    spec:
      serviceAccountName: {{ include "lens.fullname" . }}-storage-config-creator
      restartPolicy: OnFailure
      containers:
        - name: create-storage-config
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              echo "=== Creating Storage Config Secret ==="
              
              NAMESPACE="{{ .Values.global.namespace }}"
              PG_SECRET_NAME="{{ include "lens.fullname" . }}-pguser-primus-lens"
              OS_SECRET_NAME="{{ .Values.opensearch.clusterName }}-admin-password"
              TARGET_SECRET_NAME="primus-lens-storage-config"
              
              # Wait for PostgreSQL secret to be available
              echo "Waiting for PostgreSQL secret: $PG_SECRET_NAME"
              RETRY=0
              MAX_RETRIES=60
              until kubectl get secret "$PG_SECRET_NAME" -n "$NAMESPACE" >/dev/null 2>&1; do
                RETRY=$((RETRY+1))
                if [ $RETRY -ge $MAX_RETRIES ]; then
                  echo "ERROR: PostgreSQL secret not found after $MAX_RETRIES attempts"
                  exit 1
                fi
                echo "Waiting for PostgreSQL secret... ($RETRY/$MAX_RETRIES)"
                sleep 5
              done
              
              # Wait for OpenSearch secret to be available
              echo "Waiting for OpenSearch secret: $OS_SECRET_NAME"
              RETRY=0
              until kubectl get secret "$OS_SECRET_NAME" -n "$NAMESPACE" >/dev/null 2>&1; do
                RETRY=$((RETRY+1))
                if [ $RETRY -ge $MAX_RETRIES ]; then
                  echo "ERROR: OpenSearch secret not found after $MAX_RETRIES attempts"
                  exit 1
                fi
                echo "Waiting for OpenSearch secret... ($RETRY/$MAX_RETRIES)"
                sleep 5
              done
              
              # Read PostgreSQL credentials
              echo "Reading PostgreSQL credentials from secret: $PG_SECRET_NAME"
              PG_PASSWORD=$(kubectl get secret "$PG_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.password}' | base64 -d)
              PG_USER=$(kubectl get secret "$PG_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.user}' | base64 -d)
              PG_DBNAME=$(kubectl get secret "$PG_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.dbname}' | base64 -d)
              PG_HOST=$(kubectl get secret "$PG_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.host}' | base64 -d)
              PG_PORT=$(kubectl get secret "$PG_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.port}' | base64 -d)
              
              # Read OpenSearch credentials
              echo "Reading OpenSearch credentials from secret: $OS_SECRET_NAME"
              OS_PASSWORD=$(kubectl get secret "$OS_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.password}' | base64 -d)
              OS_USERNAME=$(kubectl get secret "$OS_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.username}' | base64 -d)
              
              echo "Creating storage config secret: $TARGET_SECRET_NAME"
              
              # Create the storage config secret
              cat <<EOF | kubectl apply -f -
              apiVersion: v1
              kind: Secret
              metadata:
                name: $TARGET_SECRET_NAME
                namespace: $NAMESPACE
                labels:
                  app.kubernetes.io/name: {{ include "lens.name" . }}
                  app.kubernetes.io/instance: {{ .Release.Name }}
                  app.kubernetes.io/component: storage-config
              type: Opaque
              stringData:
                opensearch: |
                  {
                    "service": "{{ .Values.opensearch.clusterName }}",
                    "port": 9200,
                    "namespace": "$NAMESPACE",
                    "scheme": "https",
                    "username": "$OS_USERNAME",
                    "password": "$OS_PASSWORD"
                  }
                prometheus: |
                  {
                    "write_service": "vminsert-{{ include "lens.fullname" . }}-vmcluster",
                    "write_port": 8480,
                    "read_service": "vmselect-{{ include "lens.fullname" . }}-vmcluster",
                    "read_port": 8481,
                    "namespace": "$NAMESPACE"
                  }
                postgres: |
                  {
                    "service": "$PG_HOST",
                    "port": $PG_PORT,
                    "namespace": "$NAMESPACE",
                    "username": "$PG_USER",
                    "password": "$PG_PASSWORD",
                    "db_name": "$PG_DBNAME",
                    "ssl_mode": "require"
                  }
              EOF
              
              echo "=== Storage Config Secret created successfully ==="

