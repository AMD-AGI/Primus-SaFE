#
# Copyright (C) 2025-2025, Advanced Micro Devices, Inc. All rights reserved.
# See LICENSE for license information.
#

---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.17.2
  name: workloads.amd.com
spec:
  group: amd.com
  names:
    kind: Workload
    listKind: WorkloadList
    plural: workloads
    singular: workload
  scope: Cluster
  versions:
  - name: v1
    schema:
      openAPIV3Schema:
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            properties:
              cronJobs:
                description: Cron Job configuration
                items:
                  properties:
                    action:
                      description: The action to take when the schedule is triggered.
                        e.g. start or scale
                      type: string
                    schedule:
                      description: |-
                        Scheduled execution time, e.g. "2025-09-30T16:04:00.000Z" or "0 3 * * *"
                        Note: Only minute-level input is supported; seconds are not supported.
                      type: string
                  required:
                  - action
                  - schedule
                  type: object
                type: array
              customerLabels:
                additionalProperties:
                  type: string
                description: |-
                  The workload will run on nodes with the user-specified labels.
                  If multiple labels are specified, all of them must be satisfied.
                type: object
              dependencies:
                description: |-
                  Dependencies defines a list of other Workloads that must complete successfully
                  before this Workload can start execution. If any dependency fails, this Workload
                  will not be scheduled and is considered failed.
                items:
                  type: string
                type: array
              entryPoint:
                description: Workload startup command, required in base64 encoding
                type: string
              env:
                additionalProperties:
                  type: string
                description: Environment variable for workload
                type: object
              groupVersionKind:
                description: |-
                  Group: An extension field that is not currently in use
                  Version: version of workload, default value is v1
                  Kind: kind of workload, Valid values includes: PyTorchJob/Deployment/StatefulSet/Authoring/AutoscalingRunnerSet, default PyTorchJob
                  AutoscalingRunnerSet is a CI/CD configuration, and if enabled, it requires NFS storage support.
                properties:
                  group:
                    type: string
                  kind:
                    type: string
                  version:
                    type: string
                type: object
              hostpath:
                description: |-
                  The workload will automatically mount the volumes defined in the workspace,
                  and you can also define specific hostPath for mounting.
                items:
                  type: string
                type: array
              image:
                description: The address of the image used by the workload
                type: string
              isSupervised:
                description: Supervision flag for the workload. When enabled, it performs
                  operations like hang detection
                type: boolean
              isTolerateAll:
                description: Indicates whether the workload tolerates node taints
                type: boolean
              jobPort:
                description: The port for pytorch-job, This field is set internally
                type: integer
              liveness:
                description: K8s liveness check. used for deployment/statefulSet
                properties:
                  failureThreshold:
                    description: Failure retry limit. default 3
                    type: integer
                  initialDelaySeconds:
                    description: Initial delay seconds. default 600s
                    type: integer
                  path:
                    description: Liveness probe HTTP path
                    type: string
                  periodSeconds:
                    description: Period check interval. default 3s
                    type: integer
                  port:
                    description: Liveness probe port
                    type: integer
                required:
                - path
                - port
                type: object
              maxRetry:
                description: 'Failure retry limit. default: 0'
                type: integer
              priority:
                description: 'Workload scheduling priority. Defaults is 0, valid range:
                  0â€“2'
                type: integer
              readiness:
                description: K8s readiness check. used for deployment/statefulSet
                properties:
                  failureThreshold:
                    description: Failure retry limit. default 3
                    type: integer
                  initialDelaySeconds:
                    description: Initial delay seconds. default 600s
                    type: integer
                  path:
                    description: Liveness probe HTTP path
                    type: string
                  periodSeconds:
                    description: Period check interval. default 3s
                    type: integer
                  port:
                    description: Liveness probe port
                    type: integer
                required:
                - path
                - port
                type: object
              resource:
                description: 'Deprecated: resource is old field, will be replaced
                  by Resources'
                properties:
                  cpu:
                    description: Requested CPU core count (e.g., 128)
                    type: string
                  ephemeralStorage:
                    description: Ephemeral-storage for pod. default 50Gi
                    type: string
                  gpu:
                    description: Requested GPU card count (e.g., 8)
                    type: string
                  gpuName:
                    description: This field is set internally. e.g. amd.com/gpu
                    type: string
                  memory:
                    description: Requested Memory size (e.g., 128Gi)
                    type: string
                  rdmaResource:
                    description: |-
                      RDMA resource is effective only with hostNetwork enabled (default: 1).
                      This field is set internally
                    type: string
                  replica:
                    description: Number of requested nodes
                    type: integer
                  sharedMemory:
                    description: 'Requested Shared Memory size (e.g., 128Gi). Used
                      for sharing data between processes. default: Memory/2'
                    type: string
                required:
                - cpu
                - memory
                - replica
                type: object
              resources:
                description: Resource requirements, It may involve multiple resources,
                  e.g., a PyTorchJob with master and worker roles.
                items:
                  properties:
                    cpu:
                      description: Requested CPU core count (e.g., 128)
                      type: string
                    ephemeralStorage:
                      description: Ephemeral-storage for pod. default 50Gi
                      type: string
                    gpu:
                      description: Requested GPU card count (e.g., 8)
                      type: string
                    gpuName:
                      description: This field is set internally. e.g. amd.com/gpu
                      type: string
                    memory:
                      description: Requested Memory size (e.g., 128Gi)
                      type: string
                    rdmaResource:
                      description: |-
                        RDMA resource is effective only with hostNetwork enabled (default: 1).
                        This field is set internally
                      type: string
                    replica:
                      description: Number of requested nodes
                      type: integer
                    sharedMemory:
                      description: 'Requested Shared Memory size (e.g., 128Gi). Used
                        for sharing data between processes. default: Memory/2'
                      type: string
                  required:
                  - cpu
                  - memory
                  - replica
                  type: object
                type: array
              secrets:
                description: |-
                  The secrets used by the workload. Including some token secrets (only for CI/CD) and specified image secrets.
                  Image secrets automatically use all image secrets bound to the workspace.
                items:
                  properties:
                    id:
                      description: Secret id, required
                      type: string
                    type:
                      description: Secret type, optional. e.g. ssh/image/general
                      type: string
                  required:
                  - id
                  type: object
                type: array
              service:
                description: Service configuration
                properties:
                  extends:
                    additionalProperties:
                      type: string
                    description: Extended environment variable
                    type: object
                  nodePort:
                    description: Port of Host Node (for NodePort type)
                    type: integer
                  port:
                    description: Service port for external access, Defaults to targetPort.
                    type: integer
                  protocol:
                    description: Service protocol, e.g. TCP/UDP, default TCP
                    type: string
                  serviceType:
                    description: Service type, e.g. ClusterIP/NodePort
                    type: string
                  targetPort:
                    description: Target container port
                    type: integer
                required:
                - protocol
                - serviceType
                - targetPort
                type: object
              sshPort:
                description: The port for ssh, This field is set internally
                type: integer
              timeout:
                description: Workload timeout in seconds. default 0 (no timeout).
                type: integer
              ttlSecondsAfterFinished:
                description: The lifecycle of the workload after completion, in seconds.
                  default 60.
                type: integer
              workspace:
                description: Requested workspace id
                type: string
            required:
            - groupVersionKind
            - priority
            - resource
            - resources
            - workspace
            type: object
          status:
            properties:
              conditions:
                description: Detailed processing workflow of the workload
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              dependenciesPhase:
                additionalProperties:
                  type: string
                description: The phase of each dependency workload.
                type: object
              endTime:
                description: Workload end time
                format: date-time
                type: string
              message:
                description: Some status descriptions of the workload. only for pending
                type: string
              nodes:
                description: The node used for each workload execution. If the workload
                  is retried multiple times, there will be multiple entries.
                items:
                  items:
                    type: string
                  type: array
                type: array
              phase:
                description: The status of workload, e.g. Pending, Running, Succeeded,
                  Failed, Stopped, Updating
                type: string
              pods:
                description: Pod info related to the workload
                items:
                  properties:
                    adminNodeName:
                      description: The admin node that the Pod is scheduled on
                      type: string
                    containers:
                      description: The Container info of pod
                      items:
                        properties:
                          exitCode:
                            description: Exit status from the last termination of
                              the container
                            format: int32
                            type: integer
                          message:
                            description: Message regarding the last termination of
                              the container
                            type: string
                          name:
                            description: Container name
                            type: string
                          reason:
                            description: (brief) reason from the last termination
                              of the container
                            type: string
                        required:
                        - exitCode
                        - name
                        type: object
                      type: array
                    endTime:
                      description: Pod end time
                      type: string
                    failedMessage:
                      description: Pod failed reason. may be empty
                      type: string
                    hostIP:
                      description: The node's IP address where the Pod is running
                      type: string
                    k8sNodeName:
                      description: The Kubernetes node that the Pod is scheduled on
                      type: string
                    phase:
                      description: 'Pod status: Pending, Running, Succeeded, Failed,
                        Unknown'
                      type: string
                    podIP:
                      description: The pod's IP address where the Pod is running
                      type: string
                    podId:
                      description: The podId
                      type: string
                    rank:
                      description: The rank of pod, only for pytorch-job
                      type: string
                    resourceId:
                      description: The id of workload resources that the pod is bound
                        to
                      type: integer
                    startTime:
                      description: Pod start time
                      type: string
                  required:
                  - podId
                  - resourceId
                  type: object
                type: array
              queuePosition:
                description: The current position of the workload in the queue, only
                  for pending
                type: integer
              ranks:
                description: The node's rank is only valid for the PyTorch job and
                  corresponds one-to-one with the nodes listed above.
                items:
                  items:
                    type: string
                  type: array
                type: array
              runnerScaleSetId:
                description: The corresponding ID applied to the cicd AutoscalingRunnerSet
                  object.
                type: string
              startTime:
                description: Workload start time
                format: date-time
                type: string
              torchFTPhase:
                additionalProperties:
                  type: string
                description: The phase of each torchFT object.
                type: object
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
