#
# Copyright (C) 2025-2025, Advanced Micro Devices, Inc. All rights reserved.
# See LICENSE for license information.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: amd-job-template
  namespace: {{ .Release.Namespace }}
  labels:
    primus-safe.workload.version: v1
    primus-safe.workload.kind: Job
    app.kubernetes.io/managed-by: Helm
  annotations:
    # The main container name should match the configuration defined in the template below
    primus-safe.main.container: job
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
data:
  template: |
    apiVersion: batch/v1
    kind: Job
    spec:
      completionMode: NonIndexed
      backoffLimit: 0
      suspend: false
      template:
        spec:
          restartPolicy: Never
          dnsPolicy: ClusterFirstWithHostNet
          initContainers:
            - name: preprocess
              image: {{ .Values.global.image_registry }}/primussafe/{{ .Values.preprocess.image }}
              imagePullPolicy: IfNotPresent
              command: ["/bin/sh", "-c", "cp -r /preprocess/* /shared-data/"]
              securityContext:
                capabilities:
                  add: [ "IPC_LOCK" ]
              resources:
                limits:
                  cpu: 1000m
                  memory: 128Mi
              volumeMounts:
                - name: shared-data
                  mountPath: /shared-data
          containers:
            - name: job
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: podinfo
                  mountPath: /etc/podinfo
                  readOnly: true
                - name: shared-data
                  mountPath: /shared-data
              env:
                - name: NCCL_SOCKET_IFNAME
                  value: "{{ .Values.net.nccl_socket_ifname }}"
                - name: NCCL_IB_HCA
                  value: "{{ .Values.net.nccl_ib_hca }}"
              securityContext:
                capabilities:
                  add: [ "IPC_LOCK", "SYS_PTRACE", "SYS_RESOURCE"]
          schedulerName: default-scheduler
          volumes:
            - name: shared-data
              emptyDir: {}
            - name: podinfo
              downwardAPI:
                items:
                - path: "labels"
                  fieldRef:
                    fieldPath: metadata.labels
          terminationGracePeriodSeconds: 5