#
# Copyright (C) 2025-2025, Advanced Micro Devices, Inc. All rights reserved.
# See LICENSE for license information.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: create-db-table
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/managed-by: Helm
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-2"
    helm.sh/hook-delete-policy: before-hook-creation
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
data:
  create_table.sql: |-
    create table if not exists workload
    (
        id SERIAL PRIMARY KEY,
        workload_id VARCHAR(64) not null,
        display_name VARCHAR(64) not null,
        workspace VARCHAR(64) not null,
        cluster VARCHAR(64) not null,
        resource VARCHAR(1024) not null,
        image VARCHAR(128) not null,
        entrypoint TEXT not null,
        gvk VARCHAR(128) not null,
        phase VARCHAR(128),
        username VARCHAR(128),
        creation_time TIMESTAMP,
        start_time TIMESTAMP,
        end_time TIMESTAMP,
        deletion_time TIMESTAMP,
        is_supervised boolean,
        is_deleted boolean,
        is_tolerate_all boolean,
        priority INT,
        max_retry INT,
        queue_position INT,
        dispatch_count int,
        ttl_second int,
        timeout int,
        env TEXT,
        description TEXT,
        pods TEXT,
        nodes TEXT,
        conditions TEXT,
        customer_labels TEXT,
        service TEXT,
        liveness VARCHAR(128),
        readiness VARCHAR(128),
        dependencies TEXT
    );

    create index if not exists T_WORKLOAD_ID_INDEX on workload (workload_id);
    create index if not exists T_WORKLOAD_DISPATCH_CNT_INDEX on workload (dispatch_count);
    create index if not exists T_WORKLOAD_WORKSPACE_INDEX on workload (workspace);
    create index if not exists T_WORKLOAD_CREATION_TIME_INDEX on workload (creation_time);
    create index if not exists T_WORKLOAD_ENDTIME_INDEX on workload (end_time);
    create index if not exists T_WORKLOAD_DESCRIPTION_INDEX on workload (description);

    alter table workload add column if not exists user_id VARCHAR(64);
    alter table workload add column if not exists workload_uid VARCHAR(36);
    alter table workload add column if not exists ranks TEXT;
    alter table workload add column if not exists cron_jobs TEXT;
    alter table workload add column if not exists secrets TEXT;
    alter table workload add column if not exists scale_runner_set VARCHAR(64);
    alter table workload add column if not exists scale_runner_id VARCHAR(128);
    alter table workload add column if not exists resources TEXT;
    alter table workload add column if not exists images TEXT;
    alter table workload add column if not exists entrypoints TEXT;
    alter table workload add column if not exists is_sticky_nodes boolean default false;

    create table if not exists fault
    (
        id SERIAL PRIMARY KEY,
        uid VARCHAR(36) not null,
        monitor_id VARCHAR(128) not null,
        message VARCHAR(1024),
        node VARCHAR(64),
        action VARCHAR(16),
        phase VARCHAR(16),
        cluster VARCHAR(64),
        creation_time TIMESTAMP,
        update_time TIMESTAMP,
        deletion_time TIMESTAMP,
        is_auto_repaired boolean
    );

    create index if not exists T_FAULT_UUID_INDEX on fault (uid);
    create index if not exists T_FAULT_CREATION_TIME_INDEX on fault (creation_time);

    create table if not exists ops_job
    (
        id SERIAL PRIMARY KEY,
        job_id VARCHAR(64) not null,
        cluster VARCHAR(128) not null,
        inputs TEXT[],
        type VARCHAR(32) not null,
        timeout int,
        user_name VARCHAR(128),
        workspace VARCHAR(64),
        creation_time TIMESTAMP,
        start_time TIMESTAMP,
        end_time TIMESTAMP,
        deletion_time TIMESTAMP,
        phase VARCHAR(64),
        conditions TEXT,
        outputs TEXT,
        is_deleted boolean
    );

    create index if not exists T_JOB_ID_INDEX on ops_job (job_id);
    create index if not exists T_JOB_PHASE_INDEX on ops_job (phase);
    create index if not exists T_JOB_PARAMS_INDEX on ops_job (inputs);
    create index if not exists T_JOB_CREATION_TIME_INDEX on ops_job (creation_time);

    alter table ops_job add column if not exists env TEXT;
    alter table ops_job add column if not exists user_id VARCHAR(64);
    alter table ops_job add column if not exists resource VARCHAR(1024);
    alter table ops_job add column if not exists image VARCHAR(128);
    alter table ops_job add column if not exists entrypoint TEXT;
    alter table ops_job add column if not exists is_tolerate_all boolean default false;
    alter table ops_job add column if not exists hostpath TEXT;
    alter table ops_job add column if not exists excluded_nodes TEXT;

    create table if not exists registry_info
    (
        id         serial
            constraint registry_info_pk
                primary key,
        name       varchar(64),
        url        varchar(256),
        username   varchar(256),
        password   varchar(256),
        "default"  bool,
        token      varchar(512),
        created_at timestamptz,
        updated_at timestamptz,
        deleted_at timestamptz
    );

    alter table registry_info
        owner to "primus-safe";

    create table if not exists image_import_job
    (
        id         serial
            constraint image_import_job_pk
                primary key,
        src_tag    varchar(256),
        dst_name   varchar(256),
        os         varchar(64),
        arch       varchar(64),
        job_name   varchar(128),
        log        text,
        layer      jsonb,
        image_id   integer,
        created_at timestamptz
    );

    alter table image_import_job
        owner to "primus-safe";

    create table if not exists image_digest
    (
        id           serial
            constraint image_digest_pk
                primary key,
        size         bigint,
        os           varchar(64),
        architecture varchar(64),
        digest       varchar(256),
        type         varchar(64),
        created_at   timestamp with time zone,
        updated_at   timestamp with time zone,
        deleted_at   timestamp with time zone
    );

    alter table image_digest
        owner to "primus-safe";

    create table if not exists image
    (
        id              serial
            constraint image_pk
                primary key,
        tag             VARCHAR(128),
        description     VARCHAR(1024),
        source          varchar(128),
        status          varchar(64),
        relation_digest jsonb,
        secret_id       varchar(64),
        created_at      timestamp with time zone,
        created_by      varchar(128),
        updated_at      timestamp with time zone,
        deleted_at      timestamp with time zone,
        deleted_by      varchar(128)
    );

    alter table image
        owner to "primus-safe";

    alter table image add column if not exists secret_id varchar(64);

    CREATE TABLE IF NOT EXISTS public_key (
       id BIGSERIAL PRIMARY KEY,
       user_id VARCHAR(64) NOT NULL,
       description VARCHAR(100) NOT NULL,
       public_key TEXT NOT NULL,
       status BOOLEAN NOT NULL DEFAULT TRUE,
       create_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
       update_time TIMESTAMPTZ,
       delete_time TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_publickey_userid ON public_key(user_id);
    CREATE UNIQUE INDEX IF NOT EXISTS idx_publickey_userid_pubkey ON public_key(user_id, public_key, delete_time);
    alter table public_key owner to "primus-safe";

    CREATE TABLE IF NOT EXISTS ssh_session_records (
       id BIGSERIAL PRIMARY KEY,
       user_id VARCHAR(64) NOT NULL,
       ssh_type VARCHAR(64) NOT NULL,
       namespace VARCHAR(64) NOT NULL,
       pod_id VARCHAR(255) NOT NULL,
       container_name VARCHAR(255) NOT NULL,
       disconnect_reason TEXT,
       disconnect_time TIMESTAMPTZ,
       create_time TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    alter table ssh_session_records owner to "primus-safe";
    create table if not exists notification
    (
        id         serial,
        kind       varchar(64),
        name       varchar(64),
        uid        varchar(64),
        channel    varchar(32),
        data       jsonb,
        status     varchar(32),
        method     varchar(32),
        error      text,
        created_at timestamptz,
        sent_at    timestamptz
    );


    alter table notification
        owner to "primus-safe";

    create table if not exists user_token
    (
        user_id    varchar(64) NOT NULL PRIMARY KEY,
        session_id VARCHAR(64) NOT NULL,
        token      TEXT NOT NULL,
        creation_time bigint,
        expire_time bigint
        );
    create index if not exists T_SESSION_ID_INDEX on user_token (session_id);
    alter table user_token owner to "primus-safe";


    create table if not exists workload_statistic
    (
        id SERIAL PRIMARY KEY,
        workload_id VARCHAR(64) not null,
        workload_uid VARCHAR(36),
        cluster VARCHAR(64),
        workspace VARCHAR(64),
        statistic_type VARCHAR(32) not null,
        avg_gpu_usage_3h DECIMAL(5, 2),
        max_gpu_usage_3h DECIMAL(5, 2),
        data_points_count INT,
        created_at TIMESTAMPTZ not null default now(),
        updated_at TIMESTAMPTZ
        );

    create index if not exists T_WORKLOAD_STAT_WORKLOAD_ID_INDEX on workload_statistic (workload_id);
    create index if not exists T_WORKLOAD_STAT_WORKLOAD_UID_INDEX on workload_statistic (workload_uid);
    create index if not exists T_WORKLOAD_STAT_WORKSPACE_INDEX on workload_statistic (workspace);
    create index if not exists T_WORKLOAD_STAT_CREATED_AT_INDEX on workload_statistic (created_at);
    create index if not exists T_WORKLOAD_STAT_TYPE_INDEX on workload_statistic (statistic_type);

    alter table workload_statistic owner to "primus-safe";


    create table if not exists node_statistic
    (
        id SERIAL PRIMARY KEY,
        cluster VARCHAR(64) not null,
        node_name VARCHAR(128) not null,
        gpu_utilization DECIMAL(5, 2),
        created_at TIMESTAMPTZ not null default now(),
        updated_at TIMESTAMPTZ,
        deleted_at TIMESTAMPTZ
        );

    create index if not exists T_NODE_STAT_CLUSTER_INDEX on node_statistic (cluster);
    create index if not exists T_NODE_STAT_NODE_NAME_INDEX on node_statistic (node_name);
    create index if not exists T_NODE_STAT_CREATED_AT_INDEX on node_statistic (created_at);

    alter table node_statistic owner to "primus-safe";


    -- Drop inference table (no longer used after unified workload architecture)
    DROP TABLE IF EXISTS inference;


    create table if not exists playground_session
    (
        id BIGSERIAL PRIMARY KEY,
        user_id VARCHAR(64) NOT NULL,
        model_name VARCHAR(128) NOT NULL,
        display_name VARCHAR(128) NOT NULL,
        system_prompt TEXT,
        messages JSONB,
        creation_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        update_time TIMESTAMPTZ,
        is_deleted BOOLEAN DEFAULT FALSE
    );

    create index if not exists T_PLAYGROUND_SESSION_QUERY_INDEX on playground_session (user_id, model_name, is_deleted, update_time DESC);

    alter table playground_session owner to "primus-safe";

    create table if not exists model
    (
        id VARCHAR(64) PRIMARY KEY,
        display_name VARCHAR(128),
        description TEXT,
        icon TEXT,
        label VARCHAR(64),
        tags TEXT,
        max_tokens INTEGER DEFAULT 0,
        version VARCHAR(64),
        source_url TEXT,
        access_mode VARCHAR(32),
        source_token VARCHAR(128),
        phase VARCHAR(32),
        message TEXT,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ,
        deletion_time TIMESTAMPTZ,
        is_deleted BOOLEAN DEFAULT FALSE
    );

    -- Add new columns for unified workload architecture
    ALTER TABLE model ADD COLUMN IF NOT EXISTS model_name VARCHAR(128);
    ALTER TABLE model ADD COLUMN IF NOT EXISTS workspace VARCHAR(64);
    ALTER TABLE model ADD COLUMN IF NOT EXISTS s3_path TEXT;
    ALTER TABLE model ADD COLUMN IF NOT EXISTS local_paths JSONB;

    -- Drop deprecated inference columns (safe to run even if columns don't exist)
    ALTER TABLE model DROP COLUMN IF EXISTS inference_id;
    ALTER TABLE model DROP COLUMN IF EXISTS inference_phase;

    -- Drop deprecated indexes
    DROP INDEX IF EXISTS T_MODEL_INFERENCE_PHASE_INDEX;

    create index if not exists T_MODEL_ACCESS_MODE_INDEX on model (access_mode, is_deleted);
    create index if not exists T_MODEL_CREATED_AT_INDEX on model (created_at, is_deleted);
    create index if not exists T_MODEL_WORKSPACE_INDEX on model (workspace, is_deleted);

    ALTER TABLE model ADD COLUMN IF NOT EXISTS max_tokens INTEGER DEFAULT 0;

    alter table model owner to "primus-safe";

    create table if not exists deployment_requests
    (
        id SERIAL PRIMARY KEY,
        deploy_name VARCHAR(64) NOT NULL,
        status VARCHAR(64) NOT NULL,
        approver_name VARCHAR(64),
        approval_result VARCHAR(64),
        env_config TEXT NOT NULL,
        description TEXT,
        rejection_reason TEXT,
        failure_reason TEXT,
        rollback_from_id BIGINT,
        created_at TIMESTAMPTZ,
        updated_at TIMESTAMPTZ,
        approved_at TIMESTAMPTZ
    );
    alter table deployment_requests owner to "primus-safe";

    create table if not exists environment_snapshots
    (
        id SERIAL PRIMARY KEY,
        deployment_request_id BIGINT NOT NULL,
        env_config TEXT NOT NULL,
        created_at TIMESTAMPTZ,
        updated_at TIMESTAMPTZ
    );
    alter table environment_snapshots owner to "primus-safe";

    -- Add workload_id column to deployment_requests for tracking associated workload
    ALTER TABLE deployment_requests ADD COLUMN IF NOT EXISTS workload_id VARCHAR(64);

    -- Add deploy_type column to support both Safe and Lens CD (default 'safe' for backward compatibility)
    ALTER TABLE deployment_requests ADD COLUMN IF NOT EXISTS deploy_type VARCHAR(16) DEFAULT 'safe';
    ALTER TABLE environment_snapshots ADD COLUMN IF NOT EXISTS deploy_type VARCHAR(16) DEFAULT 'safe';
    CREATE INDEX IF NOT EXISTS idx_deploy_type ON deployment_requests(deploy_type);

    -- Add base_snapshot_id to record the snapshot before deployment (for accurate diff calculation)
    ALTER TABLE deployment_requests ADD COLUMN IF NOT EXISTS base_snapshot_id BIGINT;

    -- API Keys table for API key authentication
    CREATE TABLE IF NOT EXISTS api_keys (
        id SERIAL PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        user_id VARCHAR(64) NOT NULL,
        user_name VARCHAR(256) NULL,
        api_key VARCHAR(128) UNIQUE NOT NULL,
        key_hint VARCHAR(16) NOT NULL,
        expiration_time TIMESTAMPTZ NOT NULL,
        creation_time TIMESTAMPTZ NOT NULL DEFAULT now(),
        whitelist JSONB NULL,
        deleted BOOLEAN NOT NULL DEFAULT false,
        deletion_time TIMESTAMPTZ NULL
    );

    CREATE UNIQUE INDEX IF NOT EXISTS idx_api_key ON api_keys(api_key);
    CREATE INDEX IF NOT EXISTS idx_api_key_user_id ON api_keys(user_id);
    CREATE INDEX IF NOT EXISTS idx_api_key_deleted ON api_keys(deleted, expiration_time);

    alter table api_keys owner to "primus-safe";

    CREATE TABLE IF NOT EXISTS audit_logs (
        id BIGSERIAL PRIMARY KEY,
        user_id VARCHAR(64) NOT NULL,
        user_name VARCHAR(256),
        user_type VARCHAR(32),
        client_ip VARCHAR(64),
        http_method VARCHAR(16) NOT NULL,
        request_path VARCHAR(512) NOT NULL,
        resource_type VARCHAR(64),
        action VARCHAR(64),
        request_body TEXT,
        response_status INT NOT NULL,
        response_body TEXT,
        latency_ms INT,
        trace_id VARCHAR(64),
        create_time TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_audit_logs_user_id ON audit_logs(user_id);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_resource_type ON audit_logs(resource_type);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_action ON audit_logs(action);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_create_time ON audit_logs(create_time DESC);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_http_method ON audit_logs(http_method);
    alter table audit_logs owner to "primus-safe";

    -- Dataset table for managing datasets
    -- All columns are defined in CREATE TABLE for new installations
    -- ALTER TABLE statements are kept for backward compatibility with existing installations
    create table if not exists dataset
    (
        id BIGSERIAL PRIMARY KEY,
        dataset_id VARCHAR(64) NOT NULL,
        display_name VARCHAR(128) NOT NULL,
        description TEXT,
        dataset_type VARCHAR(32) NOT NULL,
        status VARCHAR(32) NOT NULL DEFAULT 'Pending',
        s3_path VARCHAR(512) NOT NULL,
        total_size BIGINT DEFAULT 0,
        file_count INT DEFAULT 0,
        message TEXT,
        local_paths JSONB DEFAULT '[]',                 -- Per-workspace download status
        workspace VARCHAR(64) DEFAULT '',               -- Workspace ID for access control, empty means public
        user_id VARCHAR(64) NOT NULL,
        user_name VARCHAR(128),
        creation_time TIMESTAMPTZ DEFAULT NOW(),
        update_time TIMESTAMPTZ,
        deletion_time TIMESTAMPTZ,
        is_deleted BOOLEAN DEFAULT FALSE
    );

    create unique index if not exists T_DATASET_ID_INDEX on dataset (dataset_id);
    create index if not exists T_DATASET_USER_ID_INDEX on dataset (user_id);
    create index if not exists T_DATASET_TYPE_INDEX on dataset (dataset_type);
    create index if not exists T_DATASET_IS_DELETED_INDEX on dataset (is_deleted);
    create index if not exists T_DATASET_WORKSPACE_INDEX on dataset (workspace);

    alter table dataset owner to "primus-safe";


    -- Evaluation task table for model evaluation
    create table if not exists evaluation_task
    (
        id BIGSERIAL PRIMARY KEY,
        task_id VARCHAR(64) NOT NULL UNIQUE,
        task_name VARCHAR(128) NOT NULL,
        description TEXT,
        
        -- Model/service association
        service_id VARCHAR(64) NOT NULL,
        service_type VARCHAR(32) NOT NULL,
        service_name VARCHAR(128),
        
        -- Evaluation configuration
        benchmarks JSONB NOT NULL,
        eval_params JSONB,
        
        -- Judge model configuration (for LLM-as-Judge mode)
        judge_service_id VARCHAR(64),
        judge_service_type VARCHAR(32),
        judge_service_name VARCHAR(128),
        
        -- Performance settings
        timeout INT DEFAULT 7200,
        concurrency INT DEFAULT 32,
        
        -- Task status
        ops_job_id VARCHAR(64),
        status VARCHAR(32) DEFAULT 'Pending',
        result_summary JSONB,
        report_s3_path VARCHAR(512),
        
        -- Ownership
        workspace VARCHAR(64),
        user_id VARCHAR(64) NOT NULL,
        user_name VARCHAR(128),
        
        -- Timestamps
        creation_time TIMESTAMPTZ DEFAULT NOW(),
        start_time TIMESTAMPTZ,
        end_time TIMESTAMPTZ,
        is_deleted BOOLEAN DEFAULT FALSE
    );

    create unique index if not exists T_EVAL_TASK_ID_INDEX on evaluation_task (task_id);
    create index if not exists T_EVAL_TASK_SERVICE_INDEX on evaluation_task (service_id);
    create index if not exists T_EVAL_TASK_STATUS_INDEX on evaluation_task (status);
    create index if not exists T_EVAL_TASK_WORKSPACE_INDEX on evaluation_task (workspace);
    create index if not exists T_EVAL_TASK_USER_INDEX on evaluation_task (user_id);
    create index if not exists T_EVAL_TASK_CREATION_INDEX on evaluation_task (creation_time);

    -- Remove deprecated progress column from existing tables
    ALTER TABLE evaluation_task DROP COLUMN IF EXISTS progress;

    alter table evaluation_task owner to "primus-safe";