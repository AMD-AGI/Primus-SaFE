#
# Copyright (C) 2025-2025, Advanced Micro Devices, Inc. All rights reserved.
# See LICENSE for license information.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: primus-safe-node-agent
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/managed-by: Helm
  annotations:
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
data:
  # Config:
  # script: The name of the script to be executed
  # id: The unique ID identifier. e.g., "001"
  # toggle: on/off. default "off"
  # cronjob: Execution interval, default "@every 30s"
  # timeoutSecond: Timeout duration in seconds. default 300
  # chip: Supported chip vendor. If empty, it means no restrictions. e.g., "amd"
  # consecutiveCount: It triggers when the condition is met N consecutive times. default 1. It is only effective when the operation fails
  # arguments: Input parameters for the script, in array format.
  #  The following reserved keywords will be automatically passed to the script by the system::
  #  1. $Node: Node information, in json format, e.g., '{"nodeName": "testNode", "workspaceId": "testWorkspace", "expectedGpuCount": 8, "observedGpuCount": 8}'
  # GPU: 0XX - 1XX
  gpu_module_001: '{"script":"gpu_module_001.sh","id":"001","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on"}'
  gpu_ecc_002: '{"script":"gpu_ecc_002.sh","id":"002","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on"}'
  gpu_bad_pages_003: '{"script":"gpu_bad_pages_003.sh","id":"003","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on"}'
  gpu_card_check_004: '{"script":"gpu_card_check_004.sh","id":"004","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on","arguments":["$Node"]}'
  gpu_device_plugin_005: '{"script":"gpu_device_plugin_005.sh","id":"005","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on","arguments":["$Node"]}'
  gpu_temperature_006: '{"script":"gpu_temperature_006.sh","id":"006","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on", "arguments":["100"]}'
  gpu_driver_007: '{"script":"gpu_driver_007.sh","id":"007","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on","arguments":["{{ .Values.monitor.gpu_driver }}"]}'
  gpu_ras_008: '{"script":"gpu_ras_008.sh","id":"008","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on"}'
  gpu_link_009: '{"script":"gpu_link_009.sh","id":"009","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on"}'
  gpu_xgmi_link_010: '{"script":"gpu_xgmi_link_010.sh","id":"010","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on"}'
  gpu_rocm_version_011: '{"script":"gpu_rocm_version_011.sh","id":"011","cronjob":"@every 600s","timeoutSecond":100,"chip":"amd","toggle":"on","arguments":["{{ .Values.monitor.rocm_version }}"]}'
  gpu_ipc_012: '{"script":"gpu_ipc_012.sh","id":"012","cronjob":"@every 300s","timeoutSecond":250,"chip":"amd","toggle":"on"}'
  gpu_rocminfo_013: '{"script":"gpu_rocminfo_013.sh","id":"013","cronjob":"@every 600s","timeoutSecond":300,"chip":"amd","toggle":"on"}'
  # Network: 2XX
  net_ib_status_201: '{"script":"net_ib_status_201.sh","id":"201","cronjob":"@every 30s","timeoutSecond":25,"chip":"amd","toggle":"on","arguments":["{{ .Values.monitor.nccl_ib_hca }}"]}'
  net_ethtool_202: '{"script":"net_ethtool_202.sh","id":"202","cronjob":"@every 300s","timeoutSecond":250,"chip":"amd","toggle":"on"}'
  net_ethernet_id_203: '{"script":"net_ethernet_id_203.sh","id":"203","cronjob":"@every 600s","timeoutSecond":300,"chip":"amd","toggle":"on","arguments":["{{ .Values.monitor.nccl_socket_ifname }}"]}'
  net_bnxt_load_204: '{"script":"net_bnxt_load_204.sh","id":"204","cronjob":"@every 600s","timeoutSecond":300,"chip":"amd","toggle":"on"}'
  net_ainic_load_205: '{"script":"net_ainic_load_205.sh","id":"205","cronjob":"@every 600s","timeoutSecond":300,"chip":"amd","toggle":"off"}'
  net_ib_devices_206: '{"script":"net_ib_devices_206.sh","id":"206","cronjob":"@every 300s","timeoutSecond":250,"chip":"amd","toggle":"on","arguments":["{{ .Values.monitor.nccl_ib_hca }}"]}'
  net_ib_gid_207: '{"script":"net_ib_gid_207.sh","id":"207","cronjob":"@every 300s","timeoutSecond":250,"chip":"amd","toggle":"on"}'
  net_ainic_devices_208: '{"script":"net_ainic_devices_208.sh","id":"208","cronjob":"@every 300s","timeoutSecond":250,"chip":"amd","toggle":"off","arguments":["{{ .Values.monitor.nccl_ib_hca }}"]}'
  # System: 3XX
  sys_timezone_301: '{"script":"sys_timezone_301.sh","id":"301","cronjob":"@every 30s","timeoutSecond":25,"toggle":"on"}'
  sys_hostname_302: '{"script":"sys_hostname_302.sh","id":"302","cronjob":"@every 30s","timeoutSecond":25,"toggle":"on"}'
  sys_containerd_303: '{"script":"sys_containerd_303.sh","id":"303","cronjob":"@every 30s","timeoutSecond":25,"toggle":"on"}'
  sys_kernel_lock_304: '{"script":"sys_kernel_lock_304.sh","id":"304","cronjob":"@every 30s","timeoutSecond":25,"toggle":"on"}'
  sys_acsctl_305: '{"script":"sys_acsctl_305.sh","id":"305","cronjob":"@every 600s","timeoutSecond":300,"toggle":"on"}'
  sys_boot_args_306: '{"script":"sys_boot_arguments_306.sh","id":"306","cronjob":"@every 600s","timeoutSecond":300,"chip":"amd","toggle":"on"}'
  sys_docker_307: '{"script":"sys_docker_307.sh","id":"307","cronjob":"@every 60s","timeoutSecond":50,"toggle":"on","arguments":["$Node","x-flannel-prod"]}'
  sys_pcie_link_308: '{"script":"sys_pcie_link_308.sh","id":"308","cronjob":"@every 300s","timeoutSecond":250,"chip":"amd","toggle":"on"}'
  sys_csi_wekafs_309: '{"script":"sys_check_container.sh","id":"309","cronjob":"@every 300s","timeoutSecond":250,"chip":"amd","toggle":"on","arguments":["csi-wekafs"]}'
  # Disk: 4XX
  nfs_check_401: '{"script":"nfs_check_401.sh","id":"401","cronjob":"@every 60s","timeoutSecond":50,"toggle":"on","arguments":["{{ .Values.monitor.nfs_server }}","{{ .Values.monitor.nfs_path }}","{{ .Values.monitor.nfs_mount }}"]}'
