{{- if .Values.s3.enable }}
apiVersion: batch/v1
kind: Job
metadata:
  # copy secret for s3 use
  name: {{ .Release.Name }}-copy-juicefs-secret
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": "pre-install"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-succeeded"
spec:
  template:
    spec:
      activeDeadlineSeconds: 300
      restartPolicy: Never
      serviceAccountName: {{ .Release.Name }}-manager
      containers:
        - name: copy-secret
          image: bitnami/kubectl:latest
          command:
            - sh
            - -c
            - |
              set -e
              
              SECRET_NAME={{ .Values.s3.secret }}
              SOURCE_NAMESPACE={{ .Values.s3.secret_namespace }}
              echo "Checking if secret ${SECRET_NAME} exists in namespace ${SOURCE_NAMESPACE}..."
              kubectl get secret "${SECRET_NAME}" -n "${SOURCE_NAMESPACE}" > /dev/null 2>&1 || {
                  echo "Error: Secret '${SECRET_NAME}' does not exist in namespace '${SOURCE_NAMESPACE}'"
                  exit 1
              }

              TARGET_NAMESPACE={{ .Release.Namespace }}
              kubectl get secret "${SECRET_NAME}" -n "${SOURCE_NAMESPACE}" -o yaml | \
              sed "s/namespace: ${SOURCE_NAMESPACE}/namespace: ${TARGET_NAMESPACE}/" | \
              kubectl apply -f -

              echo "Copy secret to namespace ${TARGET_NAMESPACE} successfully"
{{- end }}